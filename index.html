<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Supply Chain Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; background: white; }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            z-index: 1000;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mapboxgl-popup-content {
            padding: 0;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.08);
            min-width: 280px;
            max-width: 320px;
        }
        
        .stage-popup {
            padding: 20px;
        }
        
        .stage-header {
            border-bottom: 1px solid #f0f2f5;
            padding-bottom: 16px;
            margin-bottom: 16px;
        }
        
        .stage-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stage-location {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }
        
        .supplier-section {
            margin-bottom: 12px;
        }
        
        .supplier-label {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .supplier-name {
            font-size: 15px;
            font-weight: 500;
            color: #374151;
            margin: 0;
        }
        
        .error-message {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            border: 1px solid #f5c6cb;
        }

        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-family: Arial, sans-serif;
        }

        .controls button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .controls button:hover {
            background: #4338ca;
        }

        .controls button.active {
            background: #10b981;
        }

        .debug-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id='map'></div>
    
    <div id="loading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div>Loading supply chain data...</div>
    </div>

    <div id="debug" class="debug-info" style="display: none;">
        <div>Debug Info:</div>
        <div id="debug-content"></div>
    </div>
   
    <script>
        // Enable debug mode
        const DEBUG = false;
        
        function debug(message) {
            if (DEBUG) {
                console.log(message);
                const debugEl = document.getElementById('debug-content');
                if (debugEl) {
                    debugEl.innerHTML += '<br>' + JSON.stringify(message);
                    document.getElementById('debug').style.display = 'block';
                }
            }
        }

        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c3V4bXRmdGJub3hob3J3c3ZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NDgxOTcsImV4cCI6MjA2ODMyNDE5N30.BTmp0eAi4yZL4oYBtJNKnd84U9ZJaTzrkPyz6WKkyto';
        const BEARER_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4c3V4bXRmdGJub3hob3J3c3ZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3NDgxOTcsImV4cCI6MjA2ODMyNDE5N30.BTmp0eAi4yZL4oYBtJNKnd84U9ZJaTzrkPyz6WKkyto';
        
        // Built-in country coordinates (no external JSON needed)
        const countryCoordinates = {
            'AD': { lat: 42.5462, lng: 1.6016, name: 'Andorra' },
            'AE': { lat: 23.4241, lng: 53.8478, name: 'United Arab Emirates' },
            'AF': { lat: 33.9391, lng: 67.7100, name: 'Afghanistan' },
            'AG': { lat: 17.0608, lng: -61.7964, name: 'Antigua and Barbuda' },
            'AL': { lat: 41.1533, lng: 20.1683, name: 'Albania' },
            'AM': { lat: 40.0691, lng: 45.0382, name: 'Armenia' },
            'AO': { lat: -11.2027, lng: 17.8739, name: 'Angola' },
            'AR': { lat: -38.4161, lng: -63.6167, name: 'Argentina' },
            'AT': { lat: 47.5162, lng: 14.5501, name: 'Austria' },
            'AU': { lat: -25.2744, lng: 133.7751, name: 'Australia' },
            'AZ': { lat: 40.1431, lng: 47.5769, name: 'Azerbaijan' },
            'BA': { lat: 43.9159, lng: 17.6791, name: 'Bosnia and Herzegovina' },
            'BB': { lat: 13.1939, lng: -59.5432, name: 'Barbados' },
            'BD': { lat: 23.6850, lng: 90.3563, name: 'Bangladesh' },
            'BE': { lat: 50.5039, lng: 4.4699, name: 'Belgium' },
            'BF': { lat: 12.2383, lng: -1.5616, name: 'Burkina Faso' },
            'BG': { lat: 42.7339, lng: 25.4858, name: 'Bulgaria' },
            'BH': { lat: 25.9304, lng: 50.6378, name: 'Bahrain' },
            'BI': { lat: -3.3731, lng: 29.9189, name: 'Burundi' },
            'BJ': { lat: 9.3077, lng: 2.3158, name: 'Benin' },
            'BN': { lat: 4.5353, lng: 114.7277, name: 'Brunei' },
            'BO': { lat: -16.2902, lng: -63.5887, name: 'Bolivia' },
            'BR': { lat: -14.2350, lng: -51.9253, name: 'Brazil' },
            'BS': { lat: 25.0343, lng: -77.3963, name: 'Bahamas' },
            'BT': { lat: 27.5142, lng: 90.4336, name: 'Bhutan' },
            'BW': { lat: -22.3285, lng: 24.6849, name: 'Botswana' },
            'BY': { lat: 53.7098, lng: 27.9534, name: 'Belarus' },
            'BZ': { lat: 17.1899, lng: -88.4976, name: 'Belize' },
            'CA': { lat: 56.1304, lng: -106.3468, name: 'Canada' },
            'CD': { lat: -4.0383, lng: 21.7587, name: 'Democratic Republic of the Congo' },
            'CF': { lat: 6.6111, lng: 20.9394, name: 'Central African Republic' },
            'CG': { lat: -0.2280, lng: 15.8277, name: 'Republic of the Congo' },
            'CH': { lat: 46.8182, lng: 8.2275, name: 'Switzerland' },
            'CI': { lat: 7.5400, lng: -5.5471, name: 'CÃ´te d\'Ivoire' },
            'CL': { lat: -35.6751, lng: -71.5430, name: 'Chile' },
            'CM': { lat: 7.3697, lng: 12.3547, name: 'Cameroon' },
            'CN': { lat: 35.8617, lng: 104.1954, name: 'China' },
            'CO': { lat: 4.5709, lng: -74.2973, name: 'Colombia' },
            'CR': { lat: 9.7489, lng: -83.7534, name: 'Costa Rica' },
            'CU': { lat: 21.5218, lng: -77.7812, name: 'Cuba' },
            'CV': { lat: 16.5388, lng: -24.0132, name: 'Cape Verde' },
            'CY': { lat: 35.1264, lng: 33.4299, name: 'Cyprus' },
            'CZ': { lat: 49.8175, lng: 15.4730, name: 'Czech Republic' },
            'DE': { lat: 51.1657, lng: 10.4515, name: 'Germany' },
            'DJ': { lat: 11.8251, lng: 42.5903, name: 'Djibouti' },
            'DK': { lat: 56.2639, lng: 9.5018, name: 'Denmark' },
            'DM': { lat: 15.4150, lng: -61.3710, name: 'Dominica' },
            'DO': { lat: 18.7357, lng: -70.1627, name: 'Dominican Republic' },
            'DZ': { lat: 28.0339, lng: 1.6596, name: 'Algeria' },
            'EC': { lat: -1.8312, lng: -78.1834, name: 'Ecuador' },
            'EE': { lat: 58.5953, lng: 25.0136, name: 'Estonia' },
            'EG': { lat: 26.0975, lng: 30.8025, name: 'Egypt' },
            'ER': { lat: 15.1794, lng: 39.7823, name: 'Eritrea' },
            'ES': { lat: 40.4637, lng: -3.7492, name: 'Spain' },
            'ET': { lat: 9.1450, lng: 40.4897, name: 'Ethiopia' },
            'FI': { lat: 61.9241, lng: 25.7482, name: 'Finland' },
            'FJ': { lat: -16.5780, lng: 179.4144, name: 'Fiji' },
            'FR': { lat: 46.2276, lng: 2.2137, name: 'France' },
            'GA': { lat: -0.8037, lng: 11.6094, name: 'Gabon' },
            'GB': { lat: 55.3781, lng: -3.4360, name: 'United Kingdom' },
            'GD': { lat: 12.2628, lng: -61.6043, name: 'Grenada' },
            'GE': { lat: 42.3154, lng: 43.3569, name: 'Georgia' },
            'GH': { lat: 7.9465, lng: -1.0232, name: 'Ghana' },
            'GM': { lat: 13.4432, lng: -15.3101, name: 'Gambia' },
            'GN': { lat: 9.9456, lng: -9.6966, name: 'Guinea' },
            'GQ': { lat: 1.6508, lng: 10.2679, name: 'Equatorial Guinea' },
            'GR': { lat: 39.0742, lng: 21.8243, name: 'Greece' },
            'GT': { lat: 15.7835, lng: -90.2308, name: 'Guatemala' },
            'GW': { lat: 11.8037, lng: -15.1804, name: 'Guinea-Bissau' },
            'GY': { lat: 4.8604, lng: -58.9302, name: 'Guyana' },
            'HK': { lat: 22.3193, lng: 114.1694, name: 'Hong Kong' },
            'HN': { lat: 15.2000, lng: -86.2419, name: 'Honduras' },
            'HR': { lat: 45.1000, lng: 15.2000, name: 'Croatia' },
            'HT': { lat: 18.9712, lng: -72.2852, name: 'Haiti' },
            'HU': { lat: 47.1625, lng: 19.5033, name: 'Hungary' },
            'ID': { lat: -0.7893, lng: 113.9213, name: 'Indonesia' },
            'IE': { lat: 53.4129, lng: -8.2439, name: 'Ireland' },
            'IL': { lat: 31.0461, lng: 34.8516, name: 'Israel' },
            'IN': { lat: 20.5937, lng: 78.9629, name: 'India' },
            'IQ': { lat: 33.2232, lng: 43.6793, name: 'Iraq' },
            'IR': { lat: 32.4279, lng: 53.6880, name: 'Iran' },
            'IS': { lat: 64.9631, lng: -19.0208, name: 'Iceland' },
            'IT': { lat: 41.8719, lng: 12.5674, name: 'Italy' },
            'JM': { lat: 18.1096, lng: -77.2975, name: 'Jamaica' },
            'JO': { lat: 30.5852, lng: 36.2384, name: 'Jordan' },
            'JP': { lat: 36.2048, lng: 138.2529, name: 'Japan' },
            'KE': { lat: -0.0236, lng: 37.9062, name: 'Kenya' },
            'KG': { lat: 41.2044, lng: 74.7661, name: 'Kyrgyzstan' },
            'KH': { lat: 12.5657, lng: 104.9910, name: 'Cambodia' },
            'KM': { lat: -11.8750, lng: 43.8722, name: 'Comoros' },
            'KN': { lat: 17.3578, lng: -62.7830, name: 'Saint Kitts and Nevis' },
            'KP': { lat: 40.3399, lng: 127.5101, name: 'North Korea' },
            'KR': { lat: 35.9078, lng: 127.7669, name: 'South Korea' },
            'KW': { lat: 29.3117, lng: 47.4818, name: 'Kuwait' },
            'KZ': { lat: 48.0196, lng: 66.9237, name: 'Kazakhstan' },
            'LA': { lat: 19.8563, lng: 102.4955, name: 'Laos' },
            'LB': { lat: 33.8547, lng: 35.8623, name: 'Lebanon' },
            'LC': { lat: 13.9094, lng: -60.9789, name: 'Saint Lucia' },
            'LI': { lat: 47.1660, lng: 9.5554, name: 'Liechtenstein' },
            'LK': { lat: 7.8731, lng: 80.7718, name: 'Sri Lanka' },
            'LR': { lat: 6.4281, lng: -9.4295, name: 'Liberia' },
            'LS': { lat: -29.6100, lng: 28.2336, name: 'Lesotho' },
            'LT': { lat: 55.1694, lng: 23.8813, name: 'Lithuania' },
            'LU': { lat: 49.8153, lng: 6.1296, name: 'Luxembourg' },
            'LV': { lat: 56.8796, lng: 24.6032, name: 'Latvia' },
            'LY': { lat: 26.3351, lng: 17.2283, name: 'Libya' },
            'MA': { lat: 31.7917, lng: -7.0926, name: 'Morocco' },
            'MC': { lat: 43.7384, lng: 7.4246, name: 'Monaco' },
            'MD': { lat: 47.4116, lng: 28.3699, name: 'Moldova' },
            'ME': { lat: 42.7087, lng: 19.3744, name: 'Montenegro' },
            'MG': { lat: -18.7669, lng: 46.8691, name: 'Madagascar' },
            'MK': { lat: 41.6086, lng: 21.7453, name: 'North Macedonia' },
            'ML': { lat: 17.5707, lng: -3.9962, name: 'Mali' },
            'MM': { lat: 21.9162, lng: 95.9560, name: 'Myanmar' },
            'MN': { lat: 46.8625, lng: 103.8467, name: 'Mongolia' },
            'MR': { lat: 21.0079, lng: -10.9408, name: 'Mauritania' },
            'MT': { lat: 35.9375, lng: 14.3754, name: 'Malta' },
            'MU': { lat: -20.3484, lng: 57.5522, name: 'Mauritius' },
            'MV': { lat: 3.2028, lng: 73.2207, name: 'Maldives' },
            'MW': { lat: -13.2543, lng: 34.3015, name: 'Malawi' },
            'MX': { lat: 23.6345, lng: -102.5528, name: 'Mexico' },
            'MY': { lat: 4.2105, lng: 101.9758, name: 'Malaysia' },
            'MZ': { lat: -18.6657, lng: 35.5296, name: 'Mozambique' },
            'NA': { lat: -22.9576, lng: 18.4904, name: 'Namibia' },
            'NE': { lat: 17.6078, lng: 8.0817, name: 'Niger' },
            'NG': { lat: 9.0820, lng: 8.6753, name: 'Nigeria' },
            'NI': { lat: 12.2652, lng: -85.2072, name: 'Nicaragua' },
            'NL': { lat: 52.1326, lng: 5.2913, name: 'Netherlands' },
            'NO': { lat: 60.4720, lng: 8.4689, name: 'Norway' },
            'NP': { lat: 28.3949, lng: 84.1240, name: 'Nepal' },
            'NZ': { lat: -40.9006, lng: 174.8860, name: 'New Zealand' },
            'OM': { lat: 21.4735, lng: 55.9754, name: 'Oman' },
            'PA': { lat: 8.5380, lng: -80.7821, name: 'Panama' },
            'PE': { lat: -9.1900, lng: -75.0152, name: 'Peru' },
            'PG': { lat: -6.3150, lng: 143.9555, name: 'Papua New Guinea' },
            'PH': { lat: 12.8797, lng: 121.7740, name: 'Philippines' },
            'PK': { lat: 30.3753, lng: 69.3451, name: 'Pakistan' },
            'PL': { lat: 51.9194, lng: 19.1451, name: 'Poland' },
            'PT': { lat: 39.3999, lng: -8.2245, name: 'Portugal' },
            'PY': { lat: -23.4425, lng: -58.4438, name: 'Paraguay' },
            'QA': { lat: 25.3548, lng: 51.1839, name: 'Qatar' },
            'RO': { lat: 45.9432, lng: 24.9668, name: 'Romania' },
            'RS': { lat: 44.0165, lng: 21.0059, name: 'Serbia' },
            'RU': { lat: 61.5240, lng: 105.3188, name: 'Russia' },
            'RW': { lat: -1.9403, lng: 29.8739, name: 'Rwanda' },
            'SA': { lat: 23.8859, lng: 45.0792, name: 'Saudi Arabia' },
            'SB': { lat: -9.6457, lng: 160.1562, name: 'Solomon Islands' },
            'SC': { lat: -4.6796, lng: 55.4920, name: 'Seychelles' },
            'SD': { lat: 12.8628, lng: 30.2176, name: 'Sudan' },
            'SE': { lat: 60.1282, lng: 18.6435, name: 'Sweden' },
            'SG': { lat: 1.3521, lng: 103.8198, name: 'Singapore' },
            'SI': { lat: 46.1512, lng: 14.9955, name: 'Slovenia' },
            'SK': { lat: 48.6690, lng: 19.6990, name: 'Slovakia' },
            'SL': { lat: 8.4606, lng: -11.7799, name: 'Sierra Leone' },
            'SM': { lat: 43.9424, lng: 12.4578, name: 'San Marino' },
            'SN': { lat: 14.4974, lng: -14.4524, name: 'Senegal' },
            'SO': { lat: 5.1521, lng: 46.1996, name: 'Somalia' },
            'SR': { lat: 3.9193, lng: -56.0278, name: 'Suriname' },
            'SS': { lat: 6.8770, lng: 31.3070, name: 'South Sudan' },
            'ST': { lat: 0.1864, lng: 6.6131, name: 'SÃ£o TomÃ© and PrÃ­ncipe' },
            'SV': { lat: 13.7942, lng: -88.8965, name: 'El Salvador' },
            'SY': { lat: 34.8021, lng: 38.9968, name: 'Syria' },
            'SZ': { lat: -26.5225, lng: 31.4659, name: 'Swaziland' },
            'TD': { lat: 15.4542, lng: 18.7322, name: 'Chad' },
            'TG': { lat: 8.6195, lng: 0.8248, name: 'Togo' },
            'TH': { lat: 15.8700, lng: 100.9925, name: 'Thailand' },
            'TJ': { lat: 38.8610, lng: 71.2761, name: 'Tajikistan' },
            'TL': { lat: -8.8742, lng: 125.7275, name: 'Timor-Leste' },
            'TM': { lat: 38.9697, lng: 59.5563, name: 'Turkmenistan' },
            'TN': { lat: 33.8869, lng: 9.5375, name: 'Tunisia' },
            'TO': { lat: -21.1789, lng: -175.1982, name: 'Tonga' },
            'TR': { lat: 38.9637, lng: 35.2433, name: 'Turkey' },
            'TT': { lat: 10.6918, lng: -61.2225, name: 'Trinidad and Tobago' },
            'TW': { lat: 23.6978, lng: 120.9605, name: 'Taiwan' },
            'TZ': { lat: -6.3690, lng: 34.8888, name: 'Tanzania' },
            'UA': { lat: 48.3794, lng: 31.1656, name: 'Ukraine' },
            'UG': { lat: 1.3733, lng: 32.2903, name: 'Uganda' },
            'US': { lat: 37.0902, lng: -95.7129, name: 'United States' },
            'UY': { lat: -32.5228, lng: -55.7658, name: 'Uruguay' },
            'UZ': { lat: 41.3775, lng: 64.5853, name: 'Uzbekistan' },
            'VA': { lat: 41.9029, lng: 12.4534, name: 'Vatican City' },
            'VC': { lat: 12.9843, lng: -61.2872, name: 'Saint Vincent and the Grenadines' },
            'VE': { lat: 6.4238, lng: -66.5897, name: 'Venezuela' },
            'VN': { lat: 14.0583, lng: 108.2772, name: 'Vietnam' },
            'VU': { lat: -15.3767, lng: 166.9592, name: 'Vanuatu' },
            'WS': { lat: -13.7590, lng: -172.1046, name: 'Samoa' },
            'XK': { lat: 42.6026, lng: 20.9030, name: 'Kosovo' },
            'YE': { lat: 15.5527, lng: 48.5164, name: 'Yemen' },
            'ZA': { lat: -30.5595, lng: 22.9375, name: 'South Africa' },
            'ZM': { lat: -13.1339, lng: 27.8493, name: 'Zambia' },
            'ZW': { lat: -19.0154, lng: 29.1549, name: 'Zimbabwe' }
        };
        
        // Store all markers and popups
        let allMarkers = [];
        let supplyChainData = [];
        let connectionLines = [];
        let popupsVisible = true;
        let connectionsVisible = true;

        // Stage type colors and icons with order priority
        const stageConfig = {
            'Raw materials': { color: '#10b981', icon: 'ð¾', bgColor: '#ecfdf5', order: 1 },
            'Yarn': { color: '#8b5cf6', icon: 'ð§¶', bgColor: '#f3f4f6', order: 2 },
            'Fabric process': { color: '#f59e0b', icon: 'ð§µ', bgColor: '#fffbeb', order: 3 },
            'Assembly': { color: '#4f46e5', icon: 'ð­', bgColor: '#eef2ff', order: 4 },
            'Warehouse': { color: '#6b7280', icon: 'ð¦', bgColor: '#f9fafb', order: 5 },
            'Transport': { color: '#06b6d4', icon: 'ð', bgColor: '#f0fdff', order: 6 },
            'default': { color: '#9ca3af', icon: 'ð', bgColor: '#f9fafb', order: 99 }
        };

        // Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmFyaWRpbyIsImEiOiJjbWVrNGFrdTIwMmNpMnFwa3NnaGIxMzZkIn0.Zfis6EEHZpQxhx5c3M-qWg';

        debug('Initializing map...');

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [20, 40],
            zoom: 2
        });

        // Function to fetch supply chain data
        async function fetchSupplyChainData(productId = 254) {
            try {
                debug('Fetching supply chain data...');
                const url = `https://axsuxmtftbnoxhorwsvb.supabase.co/rest/v1/product_stages?product_id=eq.${productId}&select=*,suppliers(name,country,city),stage_types(stage_name)`;
                debug('URL: ' + url);
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': `Bearer ${BEARER_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                debug('Response status: ' + response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                debug('Data received: ' + data.length + ' records');
                return data;
            } catch (error) {
                debug('Error fetching data: ' + error.message);
                console.error('Error fetching supply chain data:', error);
                throw error;
            }
        }

        // Function to get coordinates for a country
        function getCountryCoordinates(countryCode, index = 0) {
    const baseCoords = countryCoordinates[countryCode] || { lat: 0, lng: 0, name: 'Unknown' };
    
    // Add small random offset to avoid exact overlap of multiple markers in same country
    const offset = 0.5; // degrees
    const offsetLat = (Math.random() - 0.5) * offset;
    const offsetLng = (Math.random() - 0.5) * offset;
    
    return {
        lat: baseCoords.lat + offsetLat,
        lng: baseCoords.lng + offsetLng,
        name: baseCoords.name
    };
}

        // Function to create connection lines between supply chain stages
        function createSupplyChainConnections() {
            debug('Creating supply chain connections...');
            
            // Sort stages by their order in the supply chain
            const sortedStages = [...supplyChainData].sort((a, b) => {
                const orderA = stageConfig[a.stage_types?.stage_name]?.order || 99;
                const orderB = stageConfig[b.stage_types?.stage_name]?.order || 99;
                return orderA - orderB;
            });

            debug('Sorted stages: ' + sortedStages.length);

            // Group stages by country to get one coordinate per country
            const stagesByCountry = {};
            sortedStages.forEach(stage => {
                const countryCode = stage.suppliers?.country;
                if (countryCode && !stagesByCountry[countryCode]) {
                    const coordinates = getCountryCoordinates(countryCode);
                    if (coordinates.lat !== 0 || coordinates.lng !== 0) {
                        stagesByCountry[countryCode] = {
                            coordinates,
                            stages: [stage],
                            order: Math.min(...stage.stage_types ? [stageConfig[stage.stage_types.stage_name]?.order || 99] : [99])
                        };
                    }
                }
            });

            // Sort countries by their earliest stage order
            const countryList = Object.entries(stagesByCountry)
                .sort(([,a], [,b]) => a.order - b.order)
                .map(([countryCode, data]) => ({
                    countryCode,
                    ...data
                }));

            debug('Countries in chain: ' + countryList.length);

            // Create connections between consecutive countries in the supply chain
            for (let i = 0; i < countryList.length - 1; i++) {
                const from = countryList[i].coordinates;
                const to = countryList[i + 1].coordinates;
                
                createConnectionLine(from, to, i);
            }
        }

        // Function to create a single connection line
        function createConnectionLine(from, to, index) {
            const lineId = `supply-line-${index}`;
            debug(`Creating line ${lineId} from ${from.name} to ${to.name}`);
            
            // Add the line source if it doesn't exist
            if (!map.getSource(lineId)) {
                map.addSource(lineId, {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        properties: {},
                        geometry: {
                            type: 'LineString',
                            coordinates: [
                                [from.lng, from.lat],
                                [to.lng, to.lat]
                            ]
                        }
                    }
                });

                // Add the line layer
                map.addLayer({
                    id: lineId,
                    type: 'line',
                    source: lineId,
                    layout: {
                        'line-join': 'round',
                        'line-cap': 'round'
                    },
                    paint: {
                        'line-color': '#3b82f6',
                        'line-width': 3,
                        'line-opacity': 0.7
                    }
                });

                connectionLines.push(lineId);
            }
        }

        // Function to create marker and popup for a stage
        // Function to create marker and popup for a stage
function createStageMarker(stage, coordinates, supplierIndex = 0) {
    const stageType = stage.stage_types?.stage_name || 'default';
    const config = stageConfig[stageType] || stageConfig.default;
    
    // Create marker element (same as before)
    const markerEl = document.createElement('div');
    markerEl.style.width = '32px';
    markerEl.style.height = '32px';
    markerEl.style.borderRadius = '50%';
    // markerEl.style.backgroundColor = config.color;
    // markerEl.style.border = '3px solid white';
    // markerEl.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
    markerEl.style.cursor = 'pointer';
    markerEl.style.display = 'flex';
    markerEl.style.alignItems = 'center';
    markerEl.style.justifyContent = 'center';
    markerEl.style.fontSize = '32px';
    markerEl.innerHTML = config.icon;

    // Get ALL suppliers in this country for the popup
  // Get ALL suppliers in this country for the popup
const countryCode = stage.suppliers?.country;
const suppliersInCountry = supplyChainData.filter(s => s.suppliers?.country === countryCode);

const location = stage.suppliers?.city ? 
    `${stage.suppliers.city}, ${coordinates.name}` : 
    coordinates.name;

// Get all supplier names, comma separated
const allSupplierNames = suppliersInCountry
    .map(s => s.suppliers?.name || 'Unknown Supplier')
    .join(', ');

// Use the clean single popup design for all
const popupContent = `
    <div class="stage-popup">
        <div class="stage-header">
            <div class="stage-title">
                <span>${config.icon}</span>
                ${stageType}
            </div>
            <p class="stage-location">${location}</p>
        </div>
        
        <div class="stage-details">
            <div class="supplier-section">
                <div class="supplier-label">Supplier${suppliersInCountry.length > 1 ? 's' : ''}</div>
                <p class="supplier-name">${allSupplierNames}</p>
            </div>
        </div>
    </div>
`;

    // Create popup (rest stays the same)
    const popup = new mapboxgl.Popup({
        offset: 25,
        closeButton: true,
        closeOnClick: false
    }).setHTML(popupContent);

    // Create marker
    const marker = new mapboxgl.Marker(markerEl)
        .setLngLat([coordinates.lng, coordinates.lat])
        .setPopup(popup)
        .addTo(map);

    // Show popup initially if popups are visible
    if (popupsVisible) {
        popup.addTo(map);
    }

    // Store marker for later control
    allMarkers.push({ marker, popup });

    return marker;
}
        // Function to show error message
        function showError(message) {
            const errorEl = document.createElement('div');
            errorEl.className = 'error-message';
            errorEl.innerHTML = `<strong>Error:</strong> ${message}`;
            document.body.appendChild(errorEl);
            
            setTimeout(() => {
                if (errorEl.parentNode) {
                    errorEl.parentNode.removeChild(errorEl);
                }
            }, 5000);
        }

        // Function to hide loading overlay
        function hideLoading() {
            const loadingEl = document.getElementById('loading');
            if (loadingEl) {
                loadingEl.remove();
            }
        }

        // Function to toggle all popups
        function toggleAllPopups() {
            const button = document.getElementById('togglePopups');
            
            if (popupsVisible) {
                // Hide all popups
                allMarkers.forEach(({ popup }) => {
                    popup.remove();
                });
                button.textContent = 'Show Popups';
                button.classList.remove('active');
                popupsVisible = false;
            } else {
                // Show all popups
                allMarkers.forEach(({ popup }) => {
                    popup.addTo(map);
                });
                button.textContent = 'Hide Popups';
                button.classList.add('active');
                popupsVisible = true;
            }
        }

        // Function to toggle connection lines
        function toggleConnections() {
            const button = document.getElementById('toggleConnections');
            
            if (connectionsVisible) {
                // Hide all connections
                connectionLines.forEach(lineId => {
                    if (map.getLayer(lineId)) {
                        map.setLayoutProperty(lineId, 'visibility', 'none');
                    }
                });
                button.textContent = 'Show Lines';
                button.classList.remove('active');
                connectionsVisible = false;
            } else {
                // Show all connections
                connectionLines.forEach(lineId => {
                    if (map.getLayer(lineId)) {
                        map.setLayoutProperty(lineId, 'visibility', 'visible');
                    }
                });
                button.textContent = 'Hide Lines';
                button.classList.add('active');
                connectionsVisible = true;
            }
        }

        // Function to reset map view
        function resetView() {
            map.flyTo({
                center: [20, 40],
                zoom: 2,
                duration: 1000
            });
        }

        // Main function to load and display supply chain data
        async function loadSupplyChainData() {
            try {
                debug('Starting to load supply chain data...');
                const data = await fetchSupplyChainData();
                
                if (!data || data.length === 0) {
                    throw new Error('No supply chain data found');
                }

                supplyChainData = data;
                debug(`Processing ${data.length} supply chain stages`);

                // Group stages by country to avoid overlapping markers
                const stagesByCountry = {};
                
                data.forEach(stage => {
                    const countryCode = stage.suppliers?.country;
                    if (countryCode) {
                        if (!stagesByCountry[countryCode]) {
                            stagesByCountry[countryCode] = [];
                        }
                        stagesByCountry[countryCode].push(stage);
                    }
                });

                debug(`Grouped into ${Object.keys(stagesByCountry).length} countries`);

                // Create markers for each country
                Object.entries(stagesByCountry).forEach(([countryCode, stages]) => {
                    const coordinates = getCountryCoordinates(countryCode);
                    
                    if (coordinates.lat !== 0 || coordinates.lng !== 0) {
                        // Create marker for each stage (for simplicity in debugging)
                        stages.forEach(stage => {
                            createStageMarker(stage, coordinates);
                        });
                    }
                });

                debug('Supply chain data loaded successfully');
                hideLoading();
                
                // Create connections after markers are created
                setTimeout(() => {
                    createSupplyChainConnections();
                }, 1000);
                
            } catch (error) {
                console.error('Error loading supply chain data:', error);
                debug('Error: ' + error.message);
                hideLoading();
                showError('Failed to load supply chain data. Error: ' + error.message);
            }
        }

        // Initialize map
        map.on('load', async () => {
            debug('Map loaded, removing text labels...');
            
            // Remove all text labels from the map for cleaner look
            const layers = map.getStyle().layers;
            layers.forEach((layer) => {
                if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
                    map.removeLayer(layer.id);
                }
            });

            debug('Starting to load supply chain data...');
            await loadSupplyChainData();
        });

        // Add event listeners for control buttons
        document.getElementById('togglePopups').addEventListener('click', toggleAllPopups);
        document.getElementById('toggleConnections').addEventListener('click', toggleConnections);
        document.getElementById('resetView').addEventListener('click', resetView);

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

        // Add error handling for map
        map.on('error', (e) => {
            console.error('Mapbox error:', e);
            debug('Mapbox error: ' + JSON.stringify(e));
            hideLoading();
            showError('Map failed to load. Please check your internet connection and Mapbox token.');
        });

        // Test the API connection on page load
        document.addEventListener('DOMContentLoaded', async () => {
            debug('Page loaded, testing API connection...');
            try {
                const testResponse = await fetch('https://axsuxmtftbnoxhorwsvb.supabase.co/rest/v1/', {
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': `Bearer ${BEARER_TOKEN}`
                    }
                });
                debug('API test response: ' + testResponse.status);
            } catch (error) {
                debug('API test failed: ' + error.message);
            }
        });
    </script>
</body>
</html>