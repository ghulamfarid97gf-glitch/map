<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Optimized Supply Chain Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
        
        .map-container {
            width: 100%;
            max-width: 1200px;
            height: 600px;
            margin: 0 auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background: white;
        }
        
        #map { 
            width: 100%; 
            height: 100%; 
            background: white; 
        }
        
        .mapboxgl-popup-content {
            padding: 20px;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.08);
            min-width: 280px;
            max-width: 320px;
        }
        
        .stage-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 6px 0;
        }
        
        .supplier-name {
            font-size: 15px;
            font-weight: 500;
            color: #374151;
            margin: 0 0 12px 0;
        }

        .detail-section {
            margin-bottom: 8px;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 14px;
            color: #374151;
            margin: 0;
        }

        .stage-badge {
            display: inline-block;
            background: #000000;
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-right: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
        }

        .legend-line {
            width: 20px;
            height: 2px;
            background: #000000;
        }

        .legend-line.dashed {
            background: repeating-linear-gradient(90deg, #000000 0, #000000 4px, transparent 4px, transparent 8px);
        }

        .mapboxgl-ctrl-attrib,
        .mapboxgl-ctrl-bottom-right,
        .mapboxgl-ctrl-bottom-left {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div class="controls">
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showArrows" checked> Show Direction Arrows
                </label>
            </div>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showRoutes" checked> Show Routes
                </label>
            </div>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showWaypoints"> Show Maritime Waypoints
                </label>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-line"></div>
                <span>Domestic Routes</span>
            </div>
            <div class="legend-item">
                <div class="legend-line dashed"></div>
                <span>International Routes</span>
            </div>
        </div>
        
        <div id='map'></div>
    </div>
   
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmFyaWRpbyIsImEiOiJjbWVrNGFrdTIwMmNpMnFwa3NnaGIxMzZkIn0.Zfis6EEHZpQxhx5c3M-qWg';

        // Essential maritime waypoints only
        const MARITIME_WAYPOINTS = {
            SINGAPORE: [103.851959, 1.290270],
            SUEZ_CANAL: [32.540504, 29.991528],
            GIBRALTAR: [-5.353521, 36.125664],
            CAPE_HORN: [-67.3, -55.9],
            DURBAN: [31.054834, -29.858680],
            ROTTERDAM: [4.470356, 51.922280]
        };

        class OptimizedMaritimeRouter {
            constructor() {
                this.routeCache = new Map();
                this.domesticThreshold = 1000; // Routes shorter than this are domestic
            }

            calculateDistance(coord1, coord2) {
                const [lng1, lat1] = coord1;
                const [lng2, lat2] = coord2;
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            isInternationalRoute(startCountry, endCountry) {
                return startCountry !== endCountry;
            }

            getOptimalRoute(start, end, startCountry, endCountry) {
                const routeKey = `${start.join(',')}-${end.join(',')}`;
                
                if (this.routeCache.has(routeKey)) {
                    return this.routeCache.get(routeKey);
                }

                const isInternational = this.isInternationalRoute(startCountry, endCountry);
                const distance = this.calculateDistance(start, end);
                
                let route;
                
                if (!isInternational || distance < this.domesticThreshold) {
                    route = [start, end];
                } else {
                    route = this.buildMaritimeRoute(start, end, startCountry, endCountry);
                }

                this.routeCache.set(routeKey, route);
                return route;
            }

            buildMaritimeRoute(start, end, startCountry, endCountry) {
                const route = [start];
                const waypoints = this.getEssentialWaypoints(startCountry, endCountry);
                route.push(...waypoints);
                route.push(end);
                return route;
            }

            getEssentialWaypoints(startCountry, endCountry) {
                // Australia to US - via Cape Horn
                if (startCountry === 'AU' && endCountry === 'US') {
                    return [MARITIME_WAYPOINTS.CAPE_HORN];
                }

                // Australia to Japan - via Singapore
                if (startCountry === 'AU' && endCountry === 'JP') {
                    return [MARITIME_WAYPOINTS.SINGAPORE];
                }

                // Zimbabwe to Japan - via Durban and Singapore
                if (startCountry === 'ZW' && endCountry === 'JP') {
                    return [MARITIME_WAYPOINTS.DURBAN, MARITIME_WAYPOINTS.SINGAPORE];
                }

                // Japan to Portugal - via Singapore, Suez, Gibraltar
                if (startCountry === 'JP' && endCountry === 'PT') {
                    return [MARITIME_WAYPOINTS.SINGAPORE, MARITIME_WAYPOINTS.SUEZ_CANAL, MARITIME_WAYPOINTS.GIBRALTAR];
                }

                // Chile to Italy - via Gibraltar
                if (startCountry === 'CL' && endCountry === 'IT') {
                    return [MARITIME_WAYPOINTS.GIBRALTAR];
                }

                // Turkey to Portugal - via Gibraltar
                if (startCountry === 'TR' && endCountry === 'PT') {
                    return [MARITIME_WAYPOINTS.GIBRALTAR];
                }

                // Italy to Portugal - via Gibraltar
                if (startCountry === 'IT' && endCountry === 'PT') {
                    return [MARITIME_WAYPOINTS.GIBRALTAR];
                }

                // Portugal to Norway - via Rotterdam
                if (startCountry === 'PT' && endCountry === 'NO') {
                    return [MARITIME_WAYPOINTS.ROTTERDAM];
                }

                // Default: direct route
                return [];
            }
        }

        // Supply chain data
        const supplyChainData = [
            // Cotton farming sources
            { id: 1, supplier: "Southern Cross Cotton Co.", country: "AU", city: "Moree", source: [149.841, -29.4628], destination: [135.7539, 35.0211], parent_supplier: "Kansai Recycled Yarn Mill", parent_location: "JP", parent_city: "Kyoto", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric" },
            { id: 2, supplier: "Outback Fibre Exports", country: "AU", city: "Toowoomba", source: [151.953, -27.5606], destination: [135.7539, 35.0211], parent_supplier: "Kansai Recycled Yarn Mill", parent_location: "JP", parent_city: "Kyoto", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric" },
            { id: 3, supplier: "Prairie Fields Cotton LLC", country: "US", city: "Lubbock", source: [-101.8552, 33.5779], destination: [135.7539, 35.0211], parent_supplier: "Kansai Recycled Yarn Mill", parent_location: "JP", parent_city: "Kyoto", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric" },
            { id: 4, supplier: "Murray River Cotton Traders", country: "AU", city: "Griffith", source: [146.0583, -34.2889], destination: [-95.3698, 29.7604], parent_supplier: "Heartland Cotton Gin Co.", parent_location: "US", parent_city: "Houston", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric" },
            { id: 5, supplier: "Sunland Cotton Growers", country: "AU", city: "St George", source: [148.589, -28.036], destination: [135.5023, 34.6937], parent_supplier: "Ishikawa Precision Spinning Works", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric" },
            { id: 6, supplier: "Goldfields Fibre Group", country: "AU", city: "Narrabri", source: [149.783, -30.331], destination: [135.5023, 34.6937], parent_supplier: "Ishikawa Precision Spinning Works", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric" },
            { id: 7, supplier: "Zambezi Valley Cotton Co.", country: "ZW", city: "Harare", source: [31.0522, -17.8292], destination: [135.5023, 34.6937], parent_supplier: "Setouchi Spinners Co., Ltd.", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric" },
            
            // Ginning
            { id: 8, supplier: "Riverbend Cotton Ginning Pty Ltd", country: "AU", city: "Moree", source: [149.841, -29.4628], destination: [135.5023, 34.6937], parent_supplier: "Setouchi Spinners Co., Ltd.", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Ginning", sub_phase: "Ginning", phase_description: "Separating cotton fibers from seeds and cleaning them for spinning.", material: "Fabric" },
            { id: 9, supplier: "Southern Fibre Ginners", country: "AU", city: "Narrabri", source: [149.783, -30.331], destination: [135.5023, 34.6937], parent_supplier: "Setouchi Spinners Co., Ltd.", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Ginning", sub_phase: "Ginning", phase_description: "Separating cotton fibers from seeds and cleaning them for spinning.", material: "Fabric" },
            { id: 10, supplier: "Heartland Cotton Gin Co.", country: "US", city: "Houston", source: [-95.3698, 29.7604], destination: [135.7539, 35.0211], parent_supplier: "Kansai Recycled Yarn Mill", parent_location: "JP", parent_city: "Kyoto", stage: "Raw Materials", level: 1, phase: "Ginning", sub_phase: "Ginning", phase_description: "Separating cotton fibers from seeds and cleaning them for spinning.", material: "Fabric" },
            
            // Spinning
            { id: 11, supplier: "Setouchi Spinners Co., Ltd.", country: "JP", city: "Osaka", source: [135.5023, 34.6937], destination: [133.4148237, 34.6100879], parent_supplier: "Kuroki", parent_location: "JP", parent_city: "Okayama", stage: "Yarn", level: 2, phase: "Spinning", sub_phase: "Spinning", phase_description: "Transforming raw fibers into continuous yarn.", material: "Fabric" },
            { id: 12, supplier: "Ishikawa Precision Spinning Works", country: "JP", city: "Osaka", source: [135.5023, 34.6937], destination: [133.4148237, 34.6100879], parent_supplier: "Kuroki", parent_location: "JP", parent_city: "Okayama", stage: "Yarn", level: 2, phase: "Spinning", sub_phase: "Spinning", phase_description: "Transforming raw fibers into continuous yarn.", material: "Fabric" },
            { id: 13, supplier: "Kansai Recycled Yarn Mill", country: "JP", city: "Kyoto", source: [135.7539, 35.0211], destination: [133.4148237, 34.6100879], parent_supplier: "Kuroki", parent_location: "JP", parent_city: "Okayama", stage: "Yarn", level: 2, phase: "Spinning", sub_phase: "Spinning", phase_description: "Transforming raw fibers into continuous yarn.", material: "Fabric" },
            
            // Weaving & Dyeing
            { id: 14, supplier: "Kuroki", country: "JP", city: "Okayama", source: [133.4148237, 34.6100879], destination: [133.467, 34.603], parent_supplier: "Kojima Indigo Rope Dyeing Co., Ltd.", parent_location: "JP", parent_city: "Ibara", stage: "Fabric process", level: 3, phase: "Forming Fabric", sub_phase: "Weaving", phase_description: "Interlacing yarns to produce woven fabrics", material: "Fabric" },
            { id: 15, supplier: "Kojima Indigo Rope Dyeing Co., Ltd.", country: "JP", city: "Ibara", source: [133.467, 34.603], destination: [135.7539, 35.0211], parent_supplier: "Ibara Denim Laundry Works", parent_location: "JP", parent_city: "Kyoto", stage: "Fabric process", level: 3, phase: "Dyeing & Finishing", sub_phase: "Dyeing", phase_description: "Coloring yarns or fabrics using dyes or pigments", material: "Fabric" },
            { id: 16, supplier: "Ibara Denim Laundry Works", country: "JP", city: "Kyoto", source: [135.7539, 35.0211], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Fabric process", level: 3, phase: "Dyeing & Washing", sub_phase: "Washing", phase_description: "Pre-treating or softening fabric through industrial washing processes.", material: "Fabric" },
            
            // Hardware trims supply chain
            { id: 17, supplier: "Andes Copper Mining Ltd.", country: "CL", city: "Santiago", source: [-70.6693, -33.4489], destination: [-71.6127, -33.0472], parent_supplier: "De Smelt co ltd.", parent_location: "CL", parent_city: "Valparaiso", stage: "Trims", level: 6, phase: "Mineral processes", sub_phase: "Mining", phase_description: "Extraction of raw minerals (such as iron ore, copper, or zinc) that will later be processed into metal components.", material: "Hardware" },
            { id: 18, supplier: "De Smelt co ltd.", country: "CL", city: "Valparaiso", source: [-71.6127, -33.0472], destination: [11.1022, 43.877], parent_supplier: "Veneto Wire Processing SRL", parent_location: "IT", parent_city: "Prato", stage: "Trims", level: 6, phase: "Mineral processes", sub_phase: "Smelting", phase_description: "Heating and refining ores to extract base metals used for hardware trims.", material: "Hardware" },
            { id: 19, supplier: "Veneto Wire Processing SRL", country: "IT", city: "Prato", source: [11.1022, 43.877], destination: [11.33, 45.52], parent_supplier: "ItalRod Metallurgy S.p.A.", parent_location: "IT", parent_city: "Arzignano", stage: "Trims", level: 6, phase: "Mineral processes", sub_phase: "Coil Preparation", phase_description: "Rolling and shaping refined metal into coils or sheets, ready for component production.", material: "Hardware" },
            { id: 20, supplier: "ItalRod Metallurgy S.p.A.", country: "IT", city: "Arzignano", source: [11.33, 45.52], destination: [-8.562, 41.339], parent_supplier: "Lusometal Finishing SA", parent_location: "PT", parent_city: "Trofa", stage: "Trims", level: 6, phase: "Wire mill", sub_phase: "Wiring", phase_description: "Drawing metal into thin wires used in zippers, snaps, and other small hardware elements.", material: "Hardware" },
            { id: 21, supplier: "Lusometal Finishing SA", country: "PT", city: "Trofa", source: [-8.562, 41.339], destination: [-8.9872353, 39.0375754], parent_supplier: "YKK", parent_location: "PT", parent_city: "Lisboa", stage: "Trims", level: 6, phase: "Finishing", sub_phase: "Electroplating", phase_description: "Applying a protective or decorative metallic coating (e.g., nickel, brass, chrome) to hardware components.", material: "Hardware" },
            { id: 22, supplier: "YKK", country: "PT", city: "Lisboa", source: [-8.9872353, 39.0375754], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Trims", level: 6, phase: "Assembly", sub_phase: "Zipper & rivet manufacturing", phase_description: "Producing finished hardware pieces like zippers, rivets, snaps, and other fasteners ready for garment assembly.", material: "Hardware" },
            
            // Thread production chain
            { id: 23, supplier: "Anatolia Spinners A.S.", country: "TR", city: "Denizli", source: [29.0963, 37.783], destination: [28.9784, 41.0082], parent_supplier: "EgeColor Tekstil Boya Ltd.", parent_location: "TR", parent_city: "Istanbul", stage: "Trims", level: 6, phase: "Spinning", sub_phase: "Spinning", phase_description: "Twisting/spinning cleaned cotton fibers into continuous yarns suitable for thread making.", material: "Cotton thread" },
            { id: 24, supplier: "EgeColor Tekstil Boya Ltd.", country: "TR", city: "Istanbul", source: [28.9784, 41.0082], destination: [-8.6151, 41.5388], parent_supplier: "Tintas do Atlantico Lda.", parent_location: "PT", parent_city: "Barcelos", stage: "Trims", level: 6, phase: "Finishing", sub_phase: "Dyeing", phase_description: "Coloring cotton threads to match garment specifications using reactive or natural dyes.", material: "Cotton thread" },
            { id: 25, supplier: "Tintas do Atlantico Lda.", country: "PT", city: "Barcelos", source: [-8.6151, 41.5388], destination: [-8.4037969, 41.388926], parent_supplier: "Crafil", parent_location: "PT", parent_city: "Oliveira Sao Mateus", stage: "Trims", level: 6, phase: "Finishing", sub_phase: "Dyeing", phase_description: "Coloring cotton threads to match garment specifications using reactive or natural dyes.", material: "Cotton thread" },
            { id: 26, supplier: "Crafil", country: "PT", city: "Oliveira Sao Mateus", source: [-8.4037969, 41.388926], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Trims", level: 6, phase: "Assembly", sub_phase: "Thread winding", phase_description: "Winding dyed or raw thread onto spools, cones, or bobbins, preparing it for sewing and garment assembly.", material: "Cotton thread" },
            
            // Leather patch production
            { id: 27, supplier: "ItalPelle Sourcing S.r.l.", country: "IT", city: "Santa Croce sull'Arno", source: [10.77, 43.71], destination: [11.33, 45.52], parent_supplier: "Conceria Valverde S.p.A", parent_location: "IT", parent_city: "Arzignano", stage: "Trims", level: 6, phase: "Slaughterhouse", sub_phase: "Hide supplier", phase_description: "Sourcing animal hides as a by-product of the meat industry.", material: "Leather patch" },
            { id: 28, supplier: "Conceria Valverde S.p.A", country: "IT", city: "Arzignano", source: [11.33, 45.52], destination: [10.847695, 44.7797229], parent_supplier: "Cadica", parent_location: "IT", parent_city: "Modena", stage: "Trims", level: 6, phase: "Leather tanning", sub_phase: "Leather tanning", phase_description: "Stabilizing hides through chemical or vegetable tanning to create durable leather.", material: "Leather patch" },
            { id: 29, supplier: "Cadica", country: "IT", city: "Modena", source: [10.847695, 44.7797229], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Trims", level: 6, phase: "Assembly", sub_phase: "Leather patch production", phase_description: "Polishing, dyeing, coating, or embossing hides for final look and performance.", material: "Leather patch" },
            
            // Labels
            { id: 30, supplier: "Passamar", country: "PT", city: "Vilarinho das Cambas", source: [-8.5747734, 41.3833695], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Trims", level: 6, phase: "Label production", sub_phase: "Label production", phase_description: "Manufacturing woven, printed, or embroidered labels that provide brand identity and care instructions for garments.", material: "Labels" },
            
            // Final assembly and warehouse
            { id: 31, supplier: "Lisama", country: "PT", city: "Guimaraes", source: [-8.2962, 41.4444], destination: [10.8200294, 59.9290137], parent_supplier: "Livid", parent_location: "NO", parent_city: "Oslo", stage: "Assembly", level: 4, phase: "Assembly", sub_phase: "Cut & Sew", phase_description: "Cutting and stitching panels and components together into garments.", material: "Product" },
            { id: 32, supplier: "Livid", country: "NO", city: "Oslo", source: [10.8200294, 59.9290137], destination: null, parent_supplier: null, parent_location: null, parent_city: null, stage: "Warehouse", level: 5, phase: "Warehouse", sub_phase: "Product storing", phase_description: "Product is stored at our central warehouse in Oslo", material: null }
        ];

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [20, 45],
            zoom: 3
        });

        const router = new OptimizedMaritimeRouter();
        let currentPopup = null;

        // Controls
        const showArrowsCheckbox = document.getElementById('showArrows');
        const showRoutesCheckbox = document.getElementById('showRoutes');
        const showWaypointsCheckbox = document.getElementById('showWaypoints');

        map.on('load', async () => {
            // Remove text labels for cleaner look
            const layers = map.getStyle().layers;
            layers.forEach((layer) => {
                if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
                    map.removeLayer(layer.id);
                }
            });

            await createRoutesAndPoints();
            setupControls();
        });

        async function createRoutesAndPoints() {
            const routeFeatures = [];
            const arrowFeatures = [];
            const waypointFeatures = [];

            for (const item of supplyChainData) {
                if (item.destination) {
                    const routeCoordinates = router.getOptimalRoute(
                        item.source, 
                        item.destination, 
                        item.country, 
                        item.parent_location
                    );
                    
                    const isInternational = router.isInternationalRoute(item.country, item.parent_location);

                    // Add route feature
                    routeFeatures.push({
                        type: 'Feature',
                        properties: {
                            id: item.id,
                            stage: item.stage,
                            supplier: item.supplier,
                            level: item.level,
                            isInternational: isInternational
                        },
                        geometry: {
                            type: 'LineString',
                            coordinates: routeCoordinates
                        }
                    });

                    // Add waypoints (excluding start and end points)
                    if (routeCoordinates.length > 2) {
                        for (let i = 1; i < routeCoordinates.length - 1; i++) {
                            waypointFeatures.push({
                                type: 'Feature',
                                properties: {
                                    routeId: item.id,
                                    waypointIndex: i,
                                    type: 'waypoint'
                                },
                                geometry: {
                                    type: 'Point',
                                    coordinates: routeCoordinates[i]
                                }
                            });
                        }
                    }

                    // Create arrows only for international routes
                    if (routeCoordinates.length >= 2 && isInternational) {
                        const arrows = createArrowsAlongRoute(routeCoordinates, 3); // Only for international routes
                        arrows.forEach(arrow => {
                            arrowFeatures.push({
                                type: 'Feature',
                                properties: {
                                    bearing: arrow.bearing,
                                    routeId: item.id,
                                    isInternational: isInternational
                                },
                                geometry: {
                                    type: 'Point',
                                    coordinates: arrow.coordinates
                                }
                            });
                        });
                    }
                }
            }

            // Add routes source and layers
            map.addSource('all-routes', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: routeFeatures
                }
            });

            // Domestic routes (solid black lines)
            map.addLayer({
                id: 'routes-domestic',
                type: 'line',
                source: 'all-routes',
                filter: ['==', ['get', 'isInternational'], false],
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#000000',
                    'line-width': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        1, 2,
                        6, 3,
                        12, 4
                    ],
                    'line-opacity': 0.5
                }
            });

            // International routes (dashed black lines)
            map.addLayer({
                id: 'routes-international',
                type: 'line',
                source: 'all-routes',
                filter: ['==', ['get', 'isInternational'], true],
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#000000',
                    'line-width': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        1, 2,
                        6, 3,
                        12, 4
                    ],
                    // 'line-opacity': 0.7,
                    'line-dasharray': [3, 2]
                }
            });

            // Add waypoints
            if (waypointFeatures.length > 0) {
                map.addSource('waypoints', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: waypointFeatures
                    }
                });

                map.addLayer({
                    id: 'waypoints',
                    type: 'circle',
                    source: 'waypoints',
                    layout: { 'visibility': 'none' },
                    paint: {
                        'circle-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            1, 2,
                            6, 3,
                            12, 4
                        ],
                        'circle-color': '#FF6B35',
                        'circle-opacity': 0.8,
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#ffffff'
                    }
                });
            }

            // Add arrows
            if (arrowFeatures.length > 0) {
                const arrowSVG = `
                    <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 10 L10 3 L10 7 L17 7 L17 13 L10 13 L10 17 Z" fill="#000000" stroke="#ffffff" stroke-width="1"/>
                    </svg>
                `;
                const arrowDataURL = 'data:image/svg+xml;base64,' + btoa(arrowSVG);

                const arrowImg = new Image();
                arrowImg.onload = () => {
                    map.addImage('direction-arrow', arrowImg);

                    map.addSource('route-arrows', {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: arrowFeatures
                        }
                    });

                    map.addLayer({
                        id: 'route-arrows',
                        type: 'symbol',
                        source: 'route-arrows',
                        layout: {
                            'icon-image': 'direction-arrow',
                            'icon-size': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                1, 0.8,
                                6, 1.1,
                                12, 1.6
                            ],
                            'icon-rotate': ['get', 'bearing'],
                            'icon-rotation-alignment': 'map',
                            'icon-allow-overlap': true,
                            'icon-ignore-placement': true
                        }
                    });
                };
                arrowImg.src = arrowDataURL;
            }

            // Add custom pin icons
            await addCustomPinIcons();
            
            // Add supplier points
            addSupplierPoints();
        }

        async function addCustomPinIcons() {
            // Create custom pin SVG for source points
            const sourcePinSVG = `
                <svg fill="#000000" height="12px" width="12px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 21.041 21.041" xml:space="preserve">
                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                    <g id="SVGRepo_iconCarrier">
                        <g>
                            <g id="c88_square">
                                <path d="M20.51,0H0.524C0.267,0,0.056,0.209,0.056,0.469v20.104c0,0.255,0.211,0.468,0.468,0.468H20.51 c0.263,0,0.476-0.213,0.476-0.468V0.469C20.986,0.209,20.772,0,20.51,0z" stroke="#ffffff" stroke-width="0.5"></path>
                            </g>
                        </g>
                    </g>
                </svg>
            `;

            // Create custom pin SVG for destination points
            const destinationPinSVG = `
                <svg fill="#000000" height="10px" width="10px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 21.041 21.041" xml:space="preserve">
                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                    <g id="SVGRepo_iconCarrier">
                        <g>
                            <g id="c88_square">
                                <path d="M20.51,0H0.524C0.267,0,0.056,0.209,0.056,0.469v20.104c0,0.255,0.211,0.468,0.468,0.468H20.51 c0.263,0,0.476-0.213,0.476-0.468V0.469C20.986,0.209,20.772,0,20.51,0z" stroke="#ffffff" stroke-width="0.5"></path>
                            </g>
                        </g>
                    </g>
                </svg>
            `;

            const sourcePinDataURL = 'data:image/svg+xml;base64,' + btoa(sourcePinSVG);
            const destinationPinDataURL = 'data:image/svg+xml;base64,' + btoa(destinationPinSVG);

            return new Promise((resolve) => {
                let loadedCount = 0;
                const totalImages = 2;

                const checkComplete = () => {
                    loadedCount++;
                    if (loadedCount === totalImages) {
                        resolve();
                    }
                };

                // Load source pin image
                const sourcePinImg = new Image();
                sourcePinImg.onload = () => {
                    map.addImage('source-pin', sourcePinImg);
                    checkComplete();
                };
                sourcePinImg.src = sourcePinDataURL;

                // Load destination pin image
                const destinationPinImg = new Image();
                destinationPinImg.onload = () => {
                    map.addImage('destination-pin', destinationPinImg);
                    checkComplete();
                };
                destinationPinImg.src = destinationPinDataURL;
            });
        }

        function createArrowsAlongRoute(coordinates, maxArrows = 3) {
            const arrows = [];
            if (coordinates.length < 2) return arrows;

            // Calculate total route length
            let totalLength = 0;
            const segmentLengths = [];
            for (let i = 0; i < coordinates.length - 1; i++) {
                const start = coordinates[i];
                const end = coordinates[i + 1];
                const segmentLength = Math.sqrt(
                    Math.pow(end[0] - start[0], 2) + Math.pow(end[1] - start[1], 2)
                );
                segmentLengths.push(segmentLength);
                totalLength += segmentLength;
            }

            // Use exactly maxArrows (3-4) arrows per route, regardless of length
            const numArrows = Math.min(maxArrows, Math.max(1, coordinates.length - 1));

            for (let arrowIndex = 1; arrowIndex <= numArrows; arrowIndex++) {
                const targetDistance = (arrowIndex / (numArrows + 1)) * totalLength;

                let accumulatedDistance = 0;
                let segmentIndex = 0;
                let segmentProgress = 0;

                // Find the segment where this arrow should be placed
                for (let i = 0; i < segmentLengths.length; i++) {
                    if (accumulatedDistance + segmentLengths[i] >= targetDistance) {
                        segmentIndex = i;
                        segmentProgress = (targetDistance - accumulatedDistance) / segmentLengths[i];
                        break;
                    }
                    accumulatedDistance += segmentLengths[i];
                }

                const segmentStart = coordinates[segmentIndex];
                const segmentEnd = coordinates[segmentIndex + 1] || segmentStart;

                // Calculate arrow position
                const arrowLng = segmentStart[0] + (segmentEnd[0] - segmentStart[0]) * segmentProgress;
                const arrowLat = segmentStart[1] + (segmentEnd[1] - segmentStart[1]) * segmentProgress;

                // Calculate bearing
                const segmentDeltaX = segmentEnd[0] - segmentStart[0];
                const segmentDeltaY = segmentEnd[1] - segmentStart[1];
                const segmentBearing = Math.atan2(segmentDeltaX, segmentDeltaY) * (180 / Math.PI) + 90;

                arrows.push({
                    coordinates: [arrowLng, arrowLat],
                    bearing: segmentBearing
                });
            }

            return arrows;
        }

        function addSupplierPoints() {
            // Source points
            map.addSource('source-points', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: supplyChainData.map(item => ({
                        type: 'Feature',
                        properties: {
                            supplier: item.supplier,
                            stage: item.stage,
                            level: item.level,
                            country: item.country,
                            city: item.city,
                            phase: item.phase,
                            sub_phase: item.sub_phase || 'N/A',
                            phase_description: item.phase_description,
                            material: item.material,
                            type: 'source'
                        },
                        geometry: {
                            type: 'Point',
                            coordinates: item.source
                        }
                    }))
                }
            });

            // Destination points
            const destinationFeatures = supplyChainData
                .filter(item => item.destination && item.parent_supplier)
                .map(item => ({
                    type: 'Feature',
                    properties: {
                        supplier: item.parent_supplier,
                        country: item.parent_location,
                        city: item.parent_city,
                        phase: item.phase,
                        sub_phase: item.sub_phase || 'N/A',
                        stage: item.stage,
                        level: item.level,
                        type: 'destination'
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: item.destination
                    }
                }));

            map.addSource('destination-points', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: destinationFeatures
                }
            });

            // Add symbol layers for points using custom icons
            map.addLayer({
                id: 'source-points',
                type: 'symbol',
                source: 'source-points',
                layout: {
                    'icon-image': 'source-pin',
                    'icon-size': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        1, 0.8,
                        6, 1.0,
                        12, 1.4
                    ],
                    'icon-allow-overlap': true,
                    'icon-ignore-placement': true
                }
            });

            map.addLayer({
                id: 'destination-points',
                type: 'symbol',
                source: 'destination-points',
                layout: {
                    'icon-image': 'destination-pin',
                    'icon-size': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        1, 0.6,
                        6, 0.8,
                        12, 1.2
                    ],
                    'icon-allow-overlap': true,
                    'icon-ignore-placement': true
                }
            });

            setupEventHandlers();
            fitMapToBounds();
        }

        function setupEventHandlers() {
            function showPopup(lngLat, content) {
                if (currentPopup) {
                    currentPopup.remove();
                }

                currentPopup = new mapboxgl.Popup({
                    offset: 25,
                    closeButton: true,
                    closeOnClick: false
                })
                    .setLngLat(lngLat)
                    .setHTML(content)
                    .addTo(map);

                currentPopup.on('close', () => {
                    currentPopup = null;
                });
            }

            // Click handlers for different point types
            map.on('click', 'source-points', (e) => {
                const props = e.features[0].properties;
                const popupContent = `
                    <div>
                        <div class="stage-title">${props.phase}</div>
                        <div class="supplier-name">${props.supplier}</div>
                         <div class="stage-badge">Level ${props.level}: ${props.stage}</div>
                        
                        <div class="detail-section">
                            <div class="detail-label">Location</div>
                            <div class="detail-value">${props.city}, ${props.country}</div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-label">Process</div>
                            <div class="detail-value">${props.sub_phase}</div>
                        </div>
                    </div>
                `;

                showPopup(e.lngLat, popupContent);
            });

            map.on('click', 'destination-points', (e) => {
                const props = e.features[0].properties;
                const popupContent = `
                     <div>
                        <div class="stage-title">${props.phase}</div>
                        <div class="supplier-name">${props.supplier}</div>
                         <div class="stage-badge">Level ${props.level}: ${props.stage}</div>
                        
                        <div class="detail-section">
                            <div class="detail-label">Location</div>
                            <div class="detail-value">${props.city}, ${props.country}</div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-label">Process</div>
                            <div class="detail-value">${props.sub_phase}</div>
                        </div>
                    </div>
                `;

                showPopup(e.lngLat, popupContent);
            });

            map.on('click', 'waypoints', (e) => {
                const popupContent = `
                    <div>
                        <div class="stage-badge">Maritime Waypoint</div>
                        <div class="stage-title">Strategic Shipping Route</div>
                        
                        <div class="detail-section">
                            <div class="detail-label">Type</div>
                            <div class="detail-value">Essential maritime chokepoint or hub</div>
                        </div>
                    </div>
                `;

                showPopup(e.lngLat, popupContent);
            });

            // Cursor changes
            ['source-points', 'destination-points', 'waypoints'].forEach(layer => {
                map.on('mouseenter', layer, () => {
                    map.getCanvas().style.cursor = 'pointer';
                });
                map.on('mouseleave', layer, () => {
                    map.getCanvas().style.cursor = '';
                });
            });
        }

        function setupControls() {
            showArrowsCheckbox.addEventListener('change', (e) => {
                const visibility = e.target.checked ? 'visible' : 'none';
                if (map.getLayer('route-arrows')) {
                    map.setLayoutProperty('route-arrows', 'visibility', visibility);
                }
            });

            showRoutesCheckbox.addEventListener('change', (e) => {
                const visibility = e.target.checked ? 'visible' : 'none';
                ['routes-domestic', 'routes-international'].forEach(layerId => {
                    if (map.getLayer(layerId)) {
                        map.setLayoutProperty(layerId, 'visibility', visibility);
                    }
                });
            });

            showWaypointsCheckbox.addEventListener('change', (e) => {
                const visibility = e.target.checked ? 'visible' : 'none';
                if (map.getLayer('waypoints')) {
                    map.setLayoutProperty('waypoints', 'visibility', visibility);
                }
            });
        }

        function fitMapToBounds() {
            const allCoordinates = [];
            supplyChainData.forEach(item => {
                allCoordinates.push(item.source);
                if (item.destination) {
                    allCoordinates.push(item.destination);
                }
            });

            const bounds = new mapboxgl.LngLatBounds();
            allCoordinates.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds, { padding: 80 });
        }

        map.on('error', (e) => {
            console.error('Mapbox error:', e);
            document.getElementById('map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: white; font-family: Arial, sans-serif; text-align: center; padding: 20px;">
                    <div>
                        <h2>Map Failed to Load</h2>
                        <p>Please ensure you have a valid Mapbox access token.</p>
                        <p>The current token appears to be invalid or expired.</p>
                    </div>
                </div>
            `;
        });
    </script>
</body>
</html>