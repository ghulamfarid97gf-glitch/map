<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Optimized Supply Chain Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
        
        .map-container {
            width: 100%;
            max-width: 1200px;
            height: 600px;
            margin: 0 auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background: white;
        }
        
        #map { 
            width: 100%; 
            height: 100%; 
            background: white; 
        }
        
        .mapboxgl-popup-content {
            padding: 20px;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.08);
            min-width: 280px;
            max-width: 320px;
        }
        
        .stage-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 6px 0;
        }
        
        .supplier-name {
            font-size: 15px;
            font-weight: 500;
            color: #374151;
            margin: 0 0 12px 0;
        }

        .detail-section {
            margin-bottom: 8px;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 14px;
            color: #374151;
            margin: 0;
        }

        .stage-badge {
            display: inline-block;
            background: #000000;
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 12px;
        }

        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-right: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 8px;
        }

        .legend-line {
            width: 20px;
            height: 2px;
            background: #000000;
        }

        .legend-line.dashed {
            background: repeating-linear-gradient(90deg, #000000 0, #000000 4px, transparent 4px, transparent 8px);
        }

        .mapboxgl-ctrl-attrib,
        .mapboxgl-ctrl-bottom-right,
        .mapboxgl-ctrl-bottom-left {
            display: none !important;
        }

        .multi-supplier-popup {
            max-height: 300px;
            overflow-y: auto;
        }

        .supplier-item {
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .supplier-item:hover {
            background-color: #f3f4f6;
        }

        .supplier-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div class="controls">
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showArrows" checked> Show Direction Arrows
                </label>
            </div>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showRoutes" checked> Show Routes
                </label>
            </div>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="showWaypoints"> Show Maritime Waypoints
                </label>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-line"></div>
                <span>Domestic Routes</span>
            </div>
            <div class="legend-item">
                <div class="legend-line dashed"></div>
                <span>International Routes</span>
            </div>
        </div>
        
        <div id='map'></div>
    </div>
   
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmFyaWRpbyIsImEiOiJjbWVrNGFrdTIwMmNpMnFwa3NnaGIxMzZkIn0.Zfis6EEHZpQxhx5c3M-qWg';

        // Essential maritime waypoints only
        const MARITIME_WAYPOINTS = {
            SINGAPORE: [103.851959, 1.290270],
            SUEZ_CANAL: [32.540504, 29.991528],
            GIBRALTAR: [-5.353521, 36.125664],
            CAPE_HORN: [-67.3, -55.9],
            DURBAN: [31.054834, -29.858680],
            ROTTERDAM: [4.470356, 51.922280]
        };

        class OptimizedMaritimeRouter {
            constructor() {
                this.routeCache = new Map();
                this.domesticThreshold = 1000;
            }

            calculateDistance(coord1, coord2) {
                const [lng1, lat1] = coord1;
                const [lng2, lat2] = coord2;
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            isInternationalRoute(startCountry, endCountry) {
                return startCountry !== endCountry;
            }

            getOptimalRoute(start, end, startCountry, endCountry) {
                const routeKey = `${start.join(',')}-${end.join(',')}`;
                
                if (this.routeCache.has(routeKey)) {
                    return this.routeCache.get(routeKey);
                }

                const isInternational = this.isInternationalRoute(startCountry, endCountry);
                const distance = this.calculateDistance(start, end);
                
                let route;
                
                if (!isInternational || distance < this.domesticThreshold) {
                    route = [start, end];
                } else {
                    route = this.buildMaritimeRoute(start, end, startCountry, endCountry);
                }

                this.routeCache.set(routeKey, route);
                return route;
            }

            buildMaritimeRoute(start, end, startCountry, endCountry) {
                const route = [start];
                const waypoints = this.getEssentialWaypoints(startCountry, endCountry);
                route.push(...waypoints);
                route.push(end);
                return route;
            }

            getEssentialWaypoints(startCountry, endCountry) {
                if (startCountry === 'AU' && endCountry === 'US') {
                    return [MARITIME_WAYPOINTS.CAPE_HORN];
                }
                if (startCountry === 'AU' && endCountry === 'JP') {
                    return [MARITIME_WAYPOINTS.SINGAPORE];
                }
                if (startCountry === 'ZW' && endCountry === 'JP') {
                    return [MARITIME_WAYPOINTS.DURBAN, MARITIME_WAYPOINTS.SINGAPORE];
                }
                if (startCountry === 'JP' && endCountry === 'PT') {
                    return [MARITIME_WAYPOINTS.SINGAPORE, MARITIME_WAYPOINTS.SUEZ_CANAL, MARITIME_WAYPOINTS.GIBRALTAR];
                }
                if (startCountry === 'CL' && endCountry === 'IT') {
                    return [MARITIME_WAYPOINTS.GIBRALTAR];
                }
                if (startCountry === 'TR' && endCountry === 'PT') {
                    return [MARITIME_WAYPOINTS.GIBRALTAR];
                }
                if (startCountry === 'IT' && endCountry === 'PT') {
                    return [MARITIME_WAYPOINTS.GIBRALTAR];
                }
                if (startCountry === 'PT' && endCountry === 'NO') {
                    return [MARITIME_WAYPOINTS.ROTTERDAM];
                }
                return [];
            }
        }

        // Supply chain data
        const supplyChainData = [
            // Raw Materials - Cotton farming sources
            { id: 1, supplier: "Southern Cross Cotton Co.", country: "AU", city: "Moree", source: [149.841, -29.4628], destination: [135.7539, 35.0211], parent_supplier: "Kansai Recycled Yarn Mill", parent_location: "JP", parent_city: "Kyoto", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 2, supplier: "Outback Fibre Exports", country: "AU", city: "Toowoomba", source: [151.953, -27.5606], destination: [135.7539, 35.0211], parent_supplier: "Kansai Recycled Yarn Mill", parent_location: "JP", parent_city: "Kyoto", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 3, supplier: "Prairie Fields Cotton LLC", country: "US", city: "Lubbock", source: [-101.8552, 33.5779], destination: [135.7539, 35.0211], parent_supplier: "Kansai Recycled Yarn Mill", parent_location: "JP", parent_city: "Kyoto", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 4, supplier: "Murray River Cotton Traders", country: "AU", city: "Griffith", source: [146.0583, -34.2889], destination: [-95.3698, 29.7604], parent_supplier: "Heartland Cotton Gin Co.", parent_location: "US", parent_city: "Houston", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 5, supplier: "Sunland Cotton Growers", country: "AU", city: "St George", source: [148.589, -28.036], destination: [135.5023, 34.6937], parent_supplier: "Ishikawa Precision Spinning Works", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 6, supplier: "Goldfields Fibre Group", country: "AU", city: "Narrabri", source: [149.783, -30.331], destination: [135.5023, 34.6937], parent_supplier: "Ishikawa Precision Spinning Works", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 7, supplier: "Blue Horizon Cotton Exports", country: "AU", city: "St George", source: [148.589, -28.036], destination: [135.5023, 34.6937], parent_supplier: "Ishikawa Precision Spinning Works", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 8, supplier: "Coral Coast Cotton Co.", country: "AU", city: "Moree", source: [149.841, -29.4628], destination: [135.5023, 34.6937], parent_supplier: "Ishikawa Precision Spinning Works", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 9, supplier: "Delta Plains Cotton Inc.", country: "US", city: "Memphis", source: [-90.049, 35.1495], destination: [149.841, -29.4628], parent_supplier: "Riverbend Cotton Ginning Pty Ltd", parent_location: "AU", parent_city: "Moree", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 10, supplier: "Lone Star Cotton Producers", country: "US", city: "Houston", source: [-95.3698, 29.7604], destination: [149.783, -30.331], parent_supplier: "Southern Fibre Ginners", parent_location: "AU", parent_city: "Narrabri", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            { id: 11, supplier: "Zambezi Valley Cotton Co.", country: "ZW", city: "Harare", source: [31.0522, -17.8292], destination: [135.5023, 34.6937], parent_supplier: "Setouchi Spinners Co., Ltd.", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers.", material: "Fabric", is_demo: true },
            
            // Ginning
            { id: 12, supplier: "Riverbend Cotton Ginning Pty Ltd", country: "AU", city: "Moree", source: [149.841, -29.4628], destination: [135.5023, 34.6937], parent_supplier: "Setouchi Spinners Co., Ltd.", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Ginning", sub_phase: "Ginning", phase_description: "Separating cotton fibers from seeds and cleaning them for spinning.", material: "Fabric", is_demo: true },
            { id: 13, supplier: "Southern Fibre Ginners", country: "AU", city: "Narrabri", source: [149.783, -30.331], destination: [135.5023, 34.6937], parent_supplier: "Setouchi Spinners Co., Ltd.", parent_location: "JP", parent_city: "Osaka", stage: "Raw Materials", level: 1, phase: "Ginning", sub_phase: "Ginning", phase_description: "Separating cotton fibers from seeds and cleaning them for spinning.", material: "Fabric", is_demo: true },
            { id: 14, supplier: "Heartland Cotton Gin Co.", country: "US", city: "Houston", source: [-95.3698, 29.7604], destination: [135.7539, 35.0211], parent_supplier: "Kansai Recycled Yarn Mill", parent_location: "JP", parent_city: "Kyoto", stage: "Raw Materials", level: 1, phase: "Ginning", sub_phase: "Ginning", phase_description: "Separating cotton fibers from seeds and cleaning them for spinning.", material: "Fabric", is_demo: true },
            
            // Yarn - Spinning
            { id: 15, supplier: "Setouchi Spinners Co., Ltd.", country: "JP", city: "Osaka", source: [135.5023, 34.6937], destination: [133.4148237, 34.6100879], parent_supplier: "Kuroki", parent_location: "JP", parent_city: "Okayama", stage: "Yarn", level: 2, phase: "Spinning", sub_phase: "Spinning", phase_description: "Transforming raw fibers into continuous yarn.", material: "Fabric", is_demo: true },
            { id: 16, supplier: "Ishikawa Precision Spinning Works", country: "JP", city: "Osaka", source: [135.5023, 34.6937], destination: [133.4148237, 34.6100879], parent_supplier: "Kuroki", parent_location: "JP", parent_city: "Okayama", stage: "Yarn", level: 2, phase: "Spinning", sub_phase: "Spinning", phase_description: "Transforming raw fibers into continuous yarn.", material: "Fabric", is_demo: true },
            { id: 17, supplier: "Kansai Recycled Yarn Mill", country: "JP", city: "Kyoto", source: [135.7539, 35.0211], destination: [133.4148237, 34.6100879], parent_supplier: "Kuroki", parent_location: "JP", parent_city: "Okayama", stage: "Yarn", level: 2, phase: "Spinning", sub_phase: "Spinning", phase_description: "Transforming raw fibers into continuous yarn.", material: "Fabric", is_demo: true },
            
            // Fabric Process
            { id: 18, supplier: "Kuroki", country: "JP", city: "Okayama", source: [133.4148237, 34.6100879], destination: [133.467, 34.603], parent_supplier: "Kojima Indigo Rope Dyeing Co., Ltd.", parent_location: "JP", parent_city: "Ibara", stage: "Fabric process", level: 3, phase: "Forming Fabric", sub_phase: "Weaving", phase_description: "Interlacing yarns to produce woven fabrics", material: "Fabric", is_demo: false },
            { id: 19, supplier: "Kojima Indigo Rope Dyeing Co., Ltd.", country: "JP", city: "Ibara", source: [133.467, 34.603], destination: [135.7539, 35.0211], parent_supplier: "Ibara Denim Laundry Works", parent_location: "JP", parent_city: "Kyoto", stage: "Fabric process", level: 3, phase: "Dyeing & Finishing", sub_phase: "Dyeing", phase_description: "Coloring yarns or fabrics using dyes or pigments", material: "Fabric", is_demo: true },
            { id: 20, supplier: "Ibara Denim Laundry Works", country: "JP", city: "Kyoto", source: [135.7539, 35.0211], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Fabric process", level: 3, phase: "Dyeing & Washing", sub_phase: "Washing", phase_description: "Pre-treating or softening fabric through industrial washing processes.", material: "Fabric", is_demo: true },
            
            // Trims - Hardware
            { id: 21, supplier: "Andes Copper Mining Ltd.", country: "CL", city: "Santiago", source: [-70.6693, -33.4489], destination: [-71.6127, -33.0472], parent_supplier: "De Smelt co ltd.", parent_location: "CL", parent_city: "Valparaiso", stage: "Trims", level: 6, phase: "Mineral processes", sub_phase: "Mining", phase_description: "Extraction of raw minerals (such as iron ore, copper, or zinc) that will later be processed into metal components.", material: "Hardware", is_demo: true },
            { id: 22, supplier: "De Smelt co ltd.", country: "CL", city: "Valparaiso", source: [-71.6127, -33.0472], destination: [11.1022, 43.877], parent_supplier: "Veneto Wire Processing SRL", parent_location: "IT", parent_city: "Prato", stage: "Trims", level: 6, phase: "Mineral processes", sub_phase: "Smelting", phase_description: "Heating and refining ores to extract base metals used for hardware trims.", material: "Hardware", is_demo: true },
            { id: 23, supplier: "Veneto Wire Processing SRL", country: "IT", city: "Prato", source: [11.1022, 43.877], destination: [11.33, 45.52], parent_supplier: "ItalRod Metallurgy S.p.A.", parent_location: "IT", parent_city: "Arzignano", stage: "Trims", level: 6, phase: "Mineral processes", sub_phase: "Coil Preparation", phase_description: "Rolling and shaping refined metal into coils or sheets, ready for component production.", material: "Hardware", is_demo: true },
            { id: 24, supplier: "ItalRod Metallurgy S.p.A.", country: "IT", city: "Arzignano", source: [11.33, 45.52], destination: [-8.562, 41.339], parent_supplier: "Lusometal Finishing SA", parent_location: "PT", parent_city: "Trofa", stage: "Trims", level: 6, phase: "Wire mill", sub_phase: "Wiring", phase_description: "Drawing metal into thin wires used in zippers, snaps, and other small hardware elements.", material: "Hardware", is_demo: true },
            { id: 25, supplier: "Lusometal Finishing SA", country: "PT", city: "Trofa", source: [-8.562, 41.339], destination: [-8.9872353, 39.0375754], parent_supplier: "YKK", parent_location: "PT", parent_city: "Lisboa", stage: "Trims", level: 6, phase: "Finishing", sub_phase: "Electroplating", phase_description: "Applying a protective or decorative metallic coating (e.g., nickel, brass, chrome) to hardware components.", material: "Hardware", is_demo: true },
            { id: 26, supplier: "YKK", country: "PT", city: "Lisboa", source: [-8.9872353, 39.0375754], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Trims", level: 6, phase: "Assembly", sub_phase: "Zipper & rivet manufacturing", phase_description: "Producing finished hardware pieces like zippers, rivets, snaps, and other fasteners ready for garment assembly.", material: "Hardware", is_demo: false },
            
            // Trims - Thread
            { id: 27, supplier: "Southern Bales Cotton Co.", country: "AU", city: "Narrabri", source: [149.783, -30.331], destination: [29.0963, 37.783], parent_supplier: "Anatolia Spinners A.S.", parent_location: "TR", parent_city: "Denizli", stage: "Trims", level: 6, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers used in thread production.", material: "Cotton thread", is_demo: true },
            { id: 28, supplier: "Riverina Fibre Harvest Pty Ltd", country: "AU", city: "Griffith", source: [146.0583, -34.2889], destination: [29.0963, 37.783], parent_supplier: "Anatolia Spinners A.S.", parent_location: "TR", parent_city: "Denizli", stage: "Trims", level: 6, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers used in thread production.", material: "Cotton thread", is_demo: true },
            { id: 29, supplier: "Prairie Delta Cotton Farms LLC", country: "US", city: "Memphis", source: [-90.049, 35.1495], destination: [29.0963, 37.783], parent_supplier: "Anatolia Spinners A.S.", parent_location: "TR", parent_city: "Denizli", stage: "Trims", level: 6, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers used in thread production.", material: "Cotton thread", is_demo: true },
            { id: 30, supplier: "Lone Star Harvest Group", country: "US", city: "Houston", source: [-95.3698, 29.7604], destination: [29.0963, 37.783], parent_supplier: "Anatolia Spinners A.S.", parent_location: "TR", parent_city: "Denizli", stage: "Trims", level: 6, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers used in thread production.", material: "Cotton thread", is_demo: true },
            { id: 31, supplier: "Zambezi Cotton Growers Ltd.", country: "ZM", city: "Lusaka", source: [28.3228, -15.3875], destination: [29.0963, 37.783], parent_supplier: "Anatolia Spinners A.S.", parent_location: "TR", parent_city: "Denizli", stage: "Trims", level: 6, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers used in thread production.", material: "Cotton thread", is_demo: true },
            { id: 32, supplier: "Sahel Fibre Cooperative", country: "ML", city: "Bamako", source: [-8.0172829, 12.638545], destination: [29.0963, 37.783], parent_supplier: "Anatolia Spinners A.S.", parent_location: "TR", parent_city: "Denizli", stage: "Trims", level: 6, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers used in thread production.", material: "Cotton thread", is_demo: true },
            { id: 33, supplier: "Great Lakes Cotton Company", country: "TZ", city: "Dar es Salaam", source: [39.2083, -6.7924], destination: [29.0963, 37.783], parent_supplier: "Anatolia Spinners A.S.", parent_location: "TR", parent_city: "Denizli", stage: "Trims", level: 6, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers used in thread production.", material: "Cotton thread", is_demo: true },
            { id: 34, supplier: "Kalahari Cotton Estates", country: "BW", city: "Gaborone", source: [25.9231, -24.6282], destination: [29.0963, 37.783], parent_supplier: "Anatolia Spinners A.S.", parent_location: "TR", parent_city: "Denizli", stage: "Trims", level: 6, phase: "Primary Harvest / Sourcing", sub_phase: "Cotton farming", phase_description: "Cultivation and harvesting of cotton plants to obtain raw fibers used in thread production.", material: "Cotton thread", is_demo: true },
            { id: 35, supplier: "Anatolia Spinners A.S.", country: "TR", city: "Denizli", source: [29.0963, 37.783], destination: [28.9784, 41.0082], parent_supplier: "EgeColor Tekstil Boya Ltd.", parent_location: "TR", parent_city: "Istanbul", stage: "Trims", level: 6, phase: "Spinning", sub_phase: "Spinning", phase_description: "Twisting/spinning cleaned cotton fibers into continuous yarns suitable for thread making.", material: "Cotton thread", is_demo: true },
            { id: 36, supplier: "EgeColor Tekstil Boya Ltd.", country: "TR", city: "Istanbul", source: [28.9784, 41.0082], destination: [-8.6151, 41.5388], parent_supplier: "Tintas do Atlantico Lda.", parent_location: "PT", parent_city: "Barcelos", stage: "Trims", level: 6, phase: "Finishing", sub_phase: "Dyeing", phase_description: "Coloring cotton threads to match garment specifications using reactive or natural dyes.", material: "Cotton thread", is_demo: true },
            { id: 37, supplier: "Tintas do Atlantico Lda.", country: "PT", city: "Barcelos", source: [-8.6151, 41.5388], destination: [-8.4037969, 41.388926], parent_supplier: "Crafil", parent_location: "PT", parent_city: "Oliveira Sao Mateus", stage: "Trims", level: 6, phase: "Finishing", sub_phase: "Dyeing", phase_description: "Coloring cotton threads to match garment specifications using reactive or natural dyes.", material: "Cotton thread", is_demo: true },
            { id: 38, supplier: "Crafil", country: "PT", city: "Oliveira Sao Mateus", source: [-8.4037969, 41.388926], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Trims", level: 6, phase: "Assembly", sub_phase: "Thread winding", phase_description: "Winding dyed or raw thread onto spools, cones, or bobbins, preparing it for sewing and garment assembly.", material: "Cotton thread", is_demo: false },
            
            // Trims - Leather
            { id: 39, supplier: "ItalPelle Sourcing S.r.l.", country: "IT", city: "Santa Croce sull'Arno", source: [10.77, 43.71], destination: [11.33, 45.52], parent_supplier: "Conceria Valverde S.p.A", parent_location: "IT", parent_city: "Arzignano", stage: "Trims", level: 6, phase: "Slaughterhouse", sub_phase: "Hide supplier", phase_description: "Sourcing animal hides as a by-product of the meat industry.", material: "Leather patch", is_demo: true },
            { id: 40, supplier: "Conceria Valverde S.p.A", country: "IT", city: "Arzignano", source: [11.33, 45.52], destination: [10.847695, 44.7797229], parent_supplier: "Cadica", parent_location: "IT", parent_city: "Modena", stage: "Trims", level: 6, phase: "Leather tanning", sub_phase: "Leather tanning", phase_description: "Stabilizing hides through chemical or vegetable tanning to create durable leather.", material: "Leather patch", is_demo: true },
            { id: 41, supplier: "Cadica", country: "IT", city: "Modena", source: [10.847695, 44.7797229], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Trims", level: 6, phase: "Assembly", sub_phase: "Leather patch production", phase_description: "Polishing, dyeing, coating, or embossing hides for final look and performance.", material: "Leather patch", is_demo: false },
            
            // Trims - Labels
            { id: 42, supplier: "Passamar", country: "PT", city: "Vilarinho das Cambas", source: [-8.5747734, 41.3833695], destination: [-8.2962, 41.4444], parent_supplier: "Lisama", parent_location: "PT", parent_city: "Guimaraes", stage: "Trims", level: 6, phase: "Label production", sub_phase: "Label production", phase_description: "Manufacturing woven, printed, or embroidered labels that provide brand identity and care instructions for garments.", material: "Labels", is_demo: false },
            
            // Assembly
            { id: 43, supplier: "Lisama", country: "PT", city: "Guimaraes", source: [-8.2962, 41.4444], destination: [-8.5206366, 41.4123881], parent_supplier: "Portipomenor", parent_location: "PT", parent_city: "Irmãos Vila Nova", stage: "Assembly", level: 4, phase: "Assembly", sub_phase: "Cut & Sew", phase_description: "Cutting and stitching panels and components together into garments.", material: "Product", is_demo: false },
            { id: 44, supplier: "IVN", country: "PT", city: "Alvarenga", source: [-8.1513, 40.9692], destination: [-8.1513, 40.9692], parent_supplier: "IVN", parent_location: "PT", parent_city: "Alvarenga", stage: "Assembly", level: 4, phase: "Assembly", sub_phase: "Laundry", phase_description: "Industrial washing of garments after assembly to achieve the desired hand-feel, fit, and appearance", material: "Product", is_demo: false },
            { id: 45, supplier: "Portipomenor", country: "PT", city: "Irmãos Vila Nova", source: [-8.5206366, 41.4123881], destination: [10.8200294, 59.9290137], parent_supplier: "Livid", parent_location: "NO", parent_city: "Oslo", stage: "Assembly", level: 4, phase: "Assembly", sub_phase: "Package & finishing", phase_description: "Final stage of garment preparation where items are pressed, tagged, folded, and packaged for distribution", material: "Product", is_demo: false },
            
            // Warehouse
            { id: 46, supplier: "Livid", country: "NO", city: "Oslo", source: [10.8200294, 59.9290137], destination: null, parent_supplier: null, parent_location: null, parent_city: null, stage: "Warehouse", level: 5, phase: "Warehouse", sub_phase: "Product storing", phase_description: "Product is stored at our central warehouse in Oslo", material: null, is_demo: false }
        ];

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [20, 45],
            zoom: 3
        });

        const router = new OptimizedMaritimeRouter();
        let currentPopup = null;

        // Controls
        const showArrowsCheckbox = document.getElementById('showArrows');
        const showRoutesCheckbox = document.getElementById('showRoutes');
        const showWaypointsCheckbox = document.getElementById('showWaypoints');

        map.on('load', async () => {
            // Remove text labels for cleaner look
            const layers = map.getStyle().layers;
            layers.forEach((layer) => {
                if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
                    map.removeLayer(layer.id);
                }
            });

            await createRoutesAndPoints();
            setupControls();
        });

        async function createRoutesAndPoints() {
            const routeFeatures = [];
            const waypointFeatures = [];

            for (const item of supplyChainData) {
                if (item.destination) {
                    const routeCoordinates = router.getOptimalRoute(
                        item.source, 
                        item.destination, 
                        item.country, 
                        item.parent_location
                    );
                    
                    const isInternational = router.isInternationalRoute(item.country, item.parent_location);

                    // Add route feature
                    routeFeatures.push({
                        type: 'Feature',
                        properties: {
                            id: item.id,
                            stage: item.stage,
                            supplier: item.supplier,
                            level: item.level,
                            isInternational: isInternational
                        },
                        geometry: {
                            type: 'LineString',
                            coordinates: routeCoordinates
                        }
                    });

                    // Add waypoints (excluding start and end points)
                    if (routeCoordinates.length > 2) {
                        for (let i = 1; i < routeCoordinates.length - 1; i++) {
                            waypointFeatures.push({
                                type: 'Feature',
                                properties: {
                                    routeId: item.id,
                                    waypointIndex: i,
                                    type: 'waypoint'
                                },
                                geometry: {
                                    type: 'Point',
                                    coordinates: routeCoordinates[i]
                                }
                            });
                        }
                    }
                }
            }

            // Add routes source and layers
            map.addSource('all-routes', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: routeFeatures
                }
            });

            // Domestic routes (solid black lines)
            map.addLayer({
                id: 'routes-domestic',
                type: 'line',
                source: 'all-routes',
                filter: ['==', ['get', 'isInternational'], false],
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#000000',
                    'line-width': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        1, 1,
                        6, 1.5,
                        12, 2
                    ],
                    'line-opacity': 0.5
                }
            });

            // International routes (dashed black lines)
            map.addLayer({
                id: 'routes-international',
                type: 'line',
                source: 'all-routes',
                filter: ['==', ['get', 'isInternational'], true],
                layout: {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                paint: {
                    'line-color': '#000000',
                    'line-width': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        1, 1,
                        6, 1.5,
                        12, 2
                    ],
                    'line-dasharray': [3, 2]
                }
            });

            // Add waypoints
            if (waypointFeatures.length > 0) {
                map.addSource('waypoints', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: waypointFeatures
                    }
                });

                map.addLayer({
                    id: 'waypoints',
                    type: 'circle',
                    source: 'waypoints',
                    layout: { 'visibility': 'none' },
                    paint: {
                        'circle-radius': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            1, 2,
                            6, 3,
                            12, 4
                        ],
                        'circle-color': '#FF6B35',
                        'circle-opacity': 0.8,
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#ffffff'
                    }
                });
            }

            // Add custom pin icons
            await addCustomPinIcons();
            
            // Add supplier points
            addSupplierPoints();
        }

        async function addCustomPinIcons() {
            // Create custom pin SVG for source points
            const sourcePinSVG = `
                <svg fill="#000000" height="12px" width="12px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 21.041 21.041" xml:space="preserve">
                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                    <g id="SVGRepo_iconCarrier">
                        <g>
                            <g id="c88_square">
                                <path d="M20.51,0H0.524C0.267,0,0.056,0.209,0.056,0.469v20.104c0,0.255,0.211,0.468,0.468,0.468H20.51 c0.263,0,0.476-0.213,0.476-0.468V0.469C20.986,0.209,20.772,0,20.51,0z" stroke="#ffffff" stroke-width="0.5"></path>
                            </g>
                        </g>
                    </g>
                </svg>
            `;

            // Create custom pin SVG for destination points
            const destinationPinSVG = `
                <svg fill="#000000" height="10px" width="10px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 21.041 21.041" xml:space="preserve">
                    <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                    <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                    <g id="SVGRepo_iconCarrier">
                        <g>
                            <g id="c88_square">
                                <path d="M20.51,0H0.524C0.267,0,0.056,0.209,0.056,0.469v20.104c0,0.255,0.211,0.468,0.468,0.468H20.51 c0.263,0,0.476-0.213,0.476-0.468V0.469C20.986,0.209,20.772,0,20.51,0z" stroke="#ffffff" stroke-width="0.5"></path>
                            </g>
                        </g>
                    </g>
                </svg>
            `;

            const sourcePinDataURL = 'data:image/svg+xml;base64,' + btoa(sourcePinSVG);
            const destinationPinDataURL = 'data:image/svg+xml;base64,' + btoa(destinationPinSVG);

            return new Promise((resolve) => {
                let loadedCount = 0;
                const totalImages = 2;

                const checkComplete = () => {
                    loadedCount++;
                    if (loadedCount === totalImages) {
                        resolve();
                    }
                };

                // Load source pin image
                const sourcePinImg = new Image();
                sourcePinImg.onload = () => {
                    map.addImage('source-pin', sourcePinImg);
                    checkComplete();
                };
                sourcePinImg.src = sourcePinDataURL;

                // Load destination pin image
                const destinationPinImg = new Image();
                destinationPinImg.onload = () => {
                    map.addImage('destination-pin', destinationPinImg);
                    checkComplete();
                };
                destinationPinImg.src = destinationPinDataURL;
            });
        }

        // Helper function to find suppliers by coordinates
        function findSuppliersByCoordinates(coordinates, tolerance = 0.001) {
            return supplyChainData.filter(item => {
                const [lng, lat] = item.source;
                const [targetLng, targetLat] = coordinates;
                return Math.abs(lng - targetLng) < tolerance && Math.abs(lat - targetLat) < tolerance;
            });
        }

        function addSupplierPoints() {
            // Group suppliers ONLY by their source coordinates
            const sourceGroups = new Map();
            
            supplyChainData.forEach(item => {
                const coordKey = `${item.source[0]},${item.source[1]}`;
                if (!sourceGroups.has(coordKey)) {
                    sourceGroups.set(coordKey, []);
                }
                sourceGroups.get(coordKey).push(item);
            });

            // Create features only for source points (grouped by source location)
            const allPointFeatures = [];
            sourceGroups.forEach((suppliers, coordKey) => {
                const [lng, lat] = coordKey.split(',').map(Number);
                allPointFeatures.push({
                    type: 'Feature',
                    properties: {
                        coordinates: [lng, lat],
                        supplierCount: suppliers.length,
                        suppliers: suppliers.map(s => ({
                            id: s.id,
                            supplier: s.supplier,
                            stage: s.stage,
                            level: s.level,
                            country: s.country,
                            city: s.city,
                            phase: s.phase,
                            sub_phase: s.sub_phase || 'N/A',
                            phase_description: s.phase_description,
                            material: s.material
                        })),
                        type: 'source'
                    },
                    geometry: {
                        type: 'Point',
                        coordinates: [lng, lat]
                    }
                });
            });

            map.addSource('all-points', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: allPointFeatures
                }
            });

            // Add single layer for all points
            map.addLayer({
                id: 'all-points',
                type: 'symbol',
                source: 'all-points',
                layout: {
                    'icon-image': 'source-pin',
                    'icon-size': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        1, 0.8,
                        6, 1.0,
                        12, 1.4
                    ],
                    'icon-allow-overlap': true,
                    'icon-ignore-placement': true
                }
            });

            setupEventHandlers();
            fitMapToBounds();
        }

        function setupEventHandlers() {
            function showPopup(lngLat, content) {
                if (currentPopup) {
                    currentPopup.remove();
                }

                currentPopup = new mapboxgl.Popup({
                    offset: 25,
                    closeButton: true,
                    closeOnClick: false,
                    maxWidth: '320px',
                    className: 'custom-popup'
                })
                    .setLngLat(lngLat)
                    .setHTML(content)
                    .addTo(map);

                currentPopup.on('close', () => {
                    currentPopup = null;
                });
            }

            function createSupplierPopupContent(suppliers) {
                if (suppliers.length === 1) {
                    const supplier = suppliers[0];
                    return `
                        <div>
                            <div class="stage-title">${supplier.phase}</div>
                            <div class="supplier-name">${supplier.supplier}</div>
                            <div class="stage-badge">${supplier.stage}</div>
                            
                            <div class="detail-section">
                                <div class="detail-label">Location</div>
                                <div class="detail-value">${supplier.city}, ${supplier.country}</div>
                            </div>
                            
                            <div class="detail-section">
                                <div class="detail-label">Process</div>
                                <div class="detail-value">${supplier.sub_phase}</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Multiple suppliers at same location
                    let content = `<div class="multi-supplier-popup">`;
                    content += `<div class="stage-title">Multiple Suppliers (${suppliers.length})</div>`;
                    content += `<div style="margin-bottom: 8px; font-size: 12px; color: #666;">Location: ${suppliers[0].city}, ${suppliers[0].country}</div>`;
                    
                    suppliers.forEach((supplier, index) => {
                        content += `
                            <div class="supplier-item">
                                <div style="font-weight: 600; margin-bottom: 4px;">${supplier.supplier}</div>
                                <div style="font-size: 12px; color: #666;">
                                    ${supplier.stage} • ${supplier.phase} • ${supplier.sub_phase}
                                </div>
                            </div>
                        `;
                    });
                    
                    content += `</div>`;
                    return content;
                }
            }

            // Click handler for all points
            map.on('click', 'all-points', (e) => {
                const props = e.features[0].properties;
                const suppliers = JSON.parse(props.suppliers);
                const popupContent = createSupplierPopupContent(suppliers);
                showPopup(e.lngLat, popupContent);
            });

            // Cursor changes
            map.on('mouseenter', 'all-points', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'all-points', () => {
                map.getCanvas().style.cursor = '';
            });
        }

        function setupControls() {
            showArrowsCheckbox.addEventListener('change', (e) => {
                const visibility = e.target.checked ? 'visible' : 'none';
                if (map.getLayer('route-arrows')) {
                    map.setLayoutProperty('route-arrows', 'visibility', visibility);
                }
            });

            showRoutesCheckbox.addEventListener('change', (e) => {
                const visibility = e.target.checked ? 'visible' : 'none';
                ['routes-domestic', 'routes-international'].forEach(layerId => {
                    if (map.getLayer(layerId)) {
                        map.setLayoutProperty(layerId, 'visibility', visibility);
                    }
                });
            });

            showWaypointsCheckbox.addEventListener('change', (e) => {
                const visibility = e.target.checked ? 'visible' : 'none';
                if (map.getLayer('waypoints')) {
                    map.setLayoutProperty('waypoints', 'visibility', visibility);
                }
            });
        }

        function fitMapToBounds() {
            const allCoordinates = [];
            supplyChainData.forEach(item => {
                allCoordinates.push(item.source);
                if (item.destination) {
                    allCoordinates.push(item.destination);
                }
            });

            const bounds = new mapboxgl.LngLatBounds();
            allCoordinates.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds, { padding: 80 });
        }

        map.on('error', (e) => {
            console.error('Mapbox error:', e);
            document.getElementById('map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: white; font-family: Arial, sans-serif; text-align: center; padding: 20px;">
                    <div>
                        <h2>Map Failed to Load</h2>
                        <p>Please ensure you have a valid Mapbox access token.</p>
                        <p>The current token appears to be invalid or expired.</p>
                    </div>
                </div>
            `;
        });
    </script>
</body>
</html>