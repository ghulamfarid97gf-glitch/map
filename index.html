<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Supply Chain Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
        
        .map-container {
            width: 100%;
            max-width: 1200px;
            height: 600px;
            margin: 0 auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background: white;
        }
        
        #map { 
            width: 100%; 
            height: 100%; 
            background: white; 
        }
        
        .mapboxgl-popup-content {
            padding: 0;
            border-radius: 12px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            border: 1px solid rgba(0, 0, 0, 0.08);
            min-width: 280px;
            max-width: 320px;
        }
        
        .stage-header {
            border-bottom: 1px solid #f0f2f5;
            padding-bottom: 16px;
            margin-bottom: 16px;
        }
        
        .stage-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 6px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stage-location {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }
        
        .supplier-section {
            margin-bottom: 12px;
        }
        
        .supplier-label {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .supplier-name {
            font-size: 15px;
            font-weight: 500;
            color: #374151;
            margin: 0;
        }

        .detail-section {
            margin-bottom: 8px;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .detail-value {
            font-size: 14px;
            color: #374151;
            margin: 0;
        }

        .stage-popup {
            padding: 20px;
        }

        .phase-section {
            border-bottom: 1px solid #f0f2f5;
            padding-bottom: 16px;
            margin-bottom: 16px;
        }

        .phase-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 4px 0;
        }

        .sub-phase-title {
            font-size: 14px;
            color: #6b7280;
            margin: 0 0 16px 0;
        }

        .stage-badge {
            display: inline-block;
            background: #000000;
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .location-section {
            margin-top: 16px;
        }

        .location-value {
            font-size: 15px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0;
        }

        .mapboxgl-ctrl-attrib,
        .mapboxgl-ctrl-bottom-right,
        .mapboxgl-ctrl-bottom-left {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="map-container">
        <div id='map'></div>
    </div>
   
    <script>
        // Replace with your actual Mapbox access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZmFyaWRpbyIsImEiOiJjbWVrNGFrdTIwMmNpMnFwa3NnaGIxMzZkIn0.Zfis6EEHZpQxhx5c3M-qWg';

        // Supply chain data with parsed coordinates
        const supplyChainData = [
            {
                id: 2322,
                supplier: "No name",
                country: "AU",
                source: [-31.25321830, 146.92109900],
                destination: [35.2989, 135.259],
                parent_supplier: "Ayabe spinning co ltd.",
                parent_location: "JP",
                stage: "Raw materials",
                level: 1,
                phase: "Primary Harvest / Sourcing",
                sub_phase: "Cotton farming"
            },
            {
                id: 2321,
                supplier: "Ayabe spinning co ltd.",
                country: "JP",
                source: [35.2989, 135.259],
                destination: [35.02107, 135.75385],
                parent_supplier: "Kuroki",
                parent_location: "JP",
                stage: "Yarn",
                level: 2,
                phase: "Thread Production",
                sub_phase: "Spinning"
            },
            {
                id: 2319,
                supplier: "Kuroki",
                country: "JP",
                source: [35.02107, 135.75385],
                destination: [35.01161, 136.96396],
                parent_supplier: "Toukai Senko co ltd",
                parent_location: "JP",
                stage: "Fabric process",
                level: 3,
                phase: "Forming Fabric",
                sub_phase: "Weaving"
            },
            {
                id: 2320,
                supplier: "TOUKAI SENKO CO.,LTD.",
                country: "JP",
                source: [35.01161, 136.96396],
                destination: [41.4444, -8.2962],
                parent_supplier: "Lisama",
                parent_location: "PT",
                stage: "Fabric process",
                level: 3,
                phase: "Dyeing & Finishing",
                sub_phase: "Dyeing"
            },
            {
                id: 2324,
                supplier: "Nilorn",
                country: "SE",
                source: [57.721035, 12.939819],
                destination: [41.4444, -8.2962],
                parent_supplier: "Lisama",
                parent_location: "PT",
                stage: "Fabric process",
                level: 3,
                phase: "Label production",
                sub_phase: "Label production"
            },
            {
                id: 2323,
                supplier: "Crafil",
                country: "PT",
                source: [41.39136, -8.40363],
                destination: [41.4444, -8.2962],
                parent_supplier: "Lisama",
                parent_location: "PT",
                stage: "Assembly",
                level: 4,
                phase: "Winding",
                sub_phase: "Cut & Sew"
            },
            {
                id: 2316,
                supplier: "Lisama",
                country: "PT",
                source: [41.4444, -8.2962],
                destination: [41.4123881, -8.5206366],
                parent_supplier: "IVN",
                parent_location: "PT",
                stage: "Assembly",
                level: 4,
                phase: "Cut & Sew",
                sub_phase: "Cut & Sew"
            },
            {
                id: 2317,
                supplier: "IVN",
                country: "PT",
                source: [41.4123881, -8.5206366],
                destination: [40.9692, -8.1513],
                parent_supplier: "Pontipromenor",
                parent_location: "PT",
                stage: "Assembly",
                level: 4,
                phase: "Laundry & Dye House",
                sub_phase: "Laundry"
            },
            {
                id: 2318,
                supplier: "Pontipormenor",
                country: "PT",
                source: [40.9692, -8.1513],
                destination: [59.9290137, 10.8200294],
                parent_supplier: "Livid",
                parent_location: "NO",
                stage: "Assembly",
                level: 4,
                phase: "Package & Finishing",
                sub_phase: "Package & finishing"
            },
            {
                id: 2325,
                supplier: "Livid",
                country: "NO",
                source: [59.9290137, 10.8200294],
                destination: null,
                parent_supplier: null,
                parent_location: null,
                stage: "Warehouse",
                level: 5,
                phase: "Product storing",
                sub_phase: null
            }
        ];

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [20, 45],
            zoom: 3
        });

        // Track current popup to prevent multiple popups
        let currentPopup = null;

        // Use black color for all elements
        const stageColors = {
            1: '#000000', // Black
            2: '#000000', // Black
            3: '#000000', // Black
            4: '#000000', // Black
            5: '#000000'  // Black
        };

        map.on('load', async () => {
            // Remove text labels
            const layers = map.getStyle().layers;
            layers.forEach((layer) => {
                if (layer.type === 'symbol' && layer.layout && layer.layout['text-field']) {
                    map.removeLayer(layer.id);
                }
            });

            // Function to get maritime route using SeaRoute API
            async function getMaritimeRoute(start, end) {
                try {
                    // Using SeaRoute API for actual maritime routing
                    const response = await fetch(`https://api.searoute.org/route/v1/?origin=${start[1]},${start[0]}&destination=${end[1]},${end[0]}&units=km`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.features && data.features[0] && data.features[0].geometry) {
                            // Convert coordinates to [lat, lng] format
                            return data.features[0].geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        }
                    }
                } catch (error) {
                    console.log('SeaRoute API failed, trying alternative...');
                }

                // Alternative: Create a manual maritime route approximation
                return createMaritimeApproximation(start, end);
            }

            // Function to create accurate maritime routes that follow coastlines and water bodies
            function createMaritimeApproximation(start, end) {
                const [startLat, startLng] = start;
                const [endLat, endLng] = end;
                
                // Major maritime waypoints (actual ports and water passages)
                const maritimeWaypoints = {
                    // Major straits and canals
                    suezNorth: [31.25, 32.3], // Northern Suez Canal entrance
                    suezSouth: [29.97, 32.5], // Southern Suez Canal entrance
                    gibraltarEast: [35.9, -5.3], // Eastern Gibraltar (Mediterranean side)
                    gibraltarWest: [36.0, -5.8], // Western Gibraltar (Atlantic side)
                    singaporeStrait: [1.2, 103.9], // Singapore Strait
                    malaccaStrait: [4.0, 100.0], // Malacca Strait entrance
                    doverStrait: [51.0, 1.4], // Dover Strait
                    
                    // Major ports and coastal points
                    mumbai: [19.0, 72.8], // Mumbai port
                    dubai: [25.2, 55.3], // Dubai port
                    piraeus: [37.9, 23.7], // Athens port
                    valencia: [39.5, -0.4], // Valencia port
                    rotterdam: [51.9, 4.1], // Rotterdam port
                    hamburg: [53.5, 10.0], // Hamburg port
                    
                    // Coastal navigation points
                    redSeaExit: [12.6, 43.3], // Bab-el-Mandeb strait
                    arabianSeaWest: [20.0, 58.0], // Western Arabian Sea
                    bayOfBiscay: [45.0, -5.0], // Bay of Biscay
                    northSeaEntry: [55.0, 2.0], // North Sea entry from Atlantic
                    baltricEntry: [57.0, 10.0], // Baltic Sea entry
                    
                    // Ocean waypoints to avoid land
                    pacificMid: [10.0, 140.0], // Mid Pacific
                    indianOceanWest: [5.0, 70.0], // Western Indian Ocean
                    atlanticEast: [40.0, -15.0], // Eastern Atlantic
                    mediterraneanCenter: [36.0, 15.0], // Central Mediterranean
                };

                let waypoints = [start];

                // Australia to Japan route (Pacific Ocean)
                if (startLng > 140 && startLat < -20 && endLng > 130 && endLat > 30) {
                    waypoints.push([startLat, 155]); // East of Australia into Pacific
                    waypoints.push([0, 155]); // Equatorial Pacific
                    waypoints.push([20, 145]); // North Pacific
                    waypoints.push([30, 140]); // Approach Japan from east
                }
                
                // Japan to Portugal route (Indian Ocean → Suez → Mediterranean → Atlantic)
                else if (startLng > 130 && startLat > 30 && endLng < 0 && endLat > 35) {
                    waypoints.push([30, 125]); // South from Japan
                    waypoints.push([15, 120]); // South China Sea
                    waypoints.push(maritimeWaypoints.singaporeStrait); // Singapore Strait
                    waypoints.push(maritimeWaypoints.malaccaStrait); // Malacca Strait
                    waypoints.push([6, 95]); // Andaman Sea
                    waypoints.push(maritimeWaypoints.indianOceanWest); // Indian Ocean (avoid land)
                    waypoints.push(maritimeWaypoints.arabianSeaWest); // Western Arabian Sea
                    waypoints.push(maritimeWaypoints.redSeaExit); // Bab-el-Mandeb strait
                    waypoints.push([20, 40]); // Red Sea navigation
                    waypoints.push(maritimeWaypoints.suezSouth); // Suez Canal south
                    waypoints.push(maritimeWaypoints.suezNorth); // Suez Canal north
                    waypoints.push(maritimeWaypoints.mediterraneanCenter); // Mediterranean
                    waypoints.push([35, 5]); // Western Mediterranean
                    waypoints.push(maritimeWaypoints.gibraltarEast); // Gibraltar east
                    waypoints.push(maritimeWaypoints.gibraltarWest); // Gibraltar west
                    waypoints.push(maritimeWaypoints.atlanticEast); // Eastern Atlantic
                    waypoints.push([42, -10]); // Atlantic approach to Portugal
                }
                
                // Sweden to Portugal route (Baltic → North Sea → Atlantic)
                else if (startLng > 10 && startLat > 55 && endLng < 0 && endLat > 35) {
                    waypoints.push([56, 12]); // Exit Baltic Sea
                    waypoints.push([57, 8]); // Skagerrak
                    waypoints.push([58, 4]); // North Sea
                    waypoints.push(maritimeWaypoints.doverStrait); // English Channel
                    waypoints.push([49, -2]); // Western English Channel
                    waypoints.push(maritimeWaypoints.bayOfBiscay); // Bay of Biscay
                    waypoints.push([43, -9]); // Atlantic approach to Portugal
                }
                
                // Portugal to Norway route (Atlantic → North Sea)
                else if (startLng < 0 && startLat > 35 && endLng > 5 && endLat > 55) {
                    waypoints.push([42, -12]); // Atlantic departure from Portugal
                    waypoints.push([45, -10]); // Western Atlantic
                    waypoints.push(maritimeWaypoints.bayOfBiscay); // Bay of Biscay
                    waypoints.push([50, -5]); // Western English Channel
                    waypoints.push(maritimeWaypoints.doverStrait); // Dover Strait
                    waypoints.push(maritimeWaypoints.northSeaEntry); // North Sea entry
                    waypoints.push([58, 8]); // North Sea to Norway
                }
                
                // Short European coastal routes
                else if (Math.abs(startLng - endLng) < 15 && Math.abs(startLat - endLat) < 15) {
                    // For short routes, add offshore waypoints to follow coast
                    const midLat = (startLat + endLat) / 2;
                    const midLng = (startLng + endLng) / 2;
                    
                    // Determine if it's Atlantic or Mediterranean coast
                    if (startLng < 0 || endLng < 0) {
                        // Atlantic coast
                        waypoints.push([midLat, Math.min(startLng, endLng) - 1]);
                    } else {
                        // European coastal waters
                        waypoints.push([midLat + 1, midLng]);
                    }
                }

                waypoints.push(end);
                return waypoints;
            }

            // Function to check if route is international
            function isInternationalRoute(sourceCountry, destCountry) {
                return sourceCountry !== destCountry;
            }

            // Create route lines with maritime routes for international connections
            for (const item of supplyChainData) {
                if (item.destination) {
                    let routeCoordinates;
                    
                    if (isInternationalRoute(item.country, item.parent_location)) {
                        // Use maritime route for international connections
                        console.log(`Getting maritime route from ${item.country} to ${item.parent_location}`);
                        const routePoints = await getMaritimeRoute(item.source, item.destination);
                        routeCoordinates = routePoints.map(point => [point[1], point[0]]); // Convert to [lng, lat] for mapbox
                    } else {
                        // Use direct line for domestic routes
                        routeCoordinates = [
                            [item.source[1], item.source[0]], // [lng, lat]
                            [item.destination[1], item.destination[0]]
                        ];
                    }

                    // Add route line
                    map.addSource(`route-${item.id}`, {
                        'type': 'geojson',
                        'data': {
                            'type': 'Feature',
                            'properties': {
                                'stage': item.stage,
                                'supplier': item.supplier,
                                'level': item.level,
                                'isInternational': isInternationalRoute(item.country, item.parent_location)
                            },
                            'geometry': {
                                'type': 'LineString',
                                'coordinates': routeCoordinates
                            }
                        }
                    });

                    map.addLayer({
                        'id': `route-${item.id}`,
                        'type': 'line',
                        'source': `route-${item.id}`,
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#000000',
                            'line-width': isInternationalRoute(item.country, item.parent_location) ? 2 : 3,
                            'line-opacity': 0.8
                        }
                    });
                }
            }

            // Add source points as circles
            map.addSource('source-points', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': supplyChainData.map(item => ({
                        'type': 'Feature',
                        'properties': {
                            'supplier': item.supplier,
                            'stage': item.stage,
                            'level': item.level,
                            'country': item.country,
                            'phase': item.phase,
                            'sub_phase': item.sub_phase || 'N/A',
                            'coordinates': `${item.source[0].toFixed(4)}, ${item.source[1].toFixed(4)}`,
                            'type': 'source'
                        },
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [item.source[1], item.source[0]]
                        }
                    }))
                }
            });

            // Add destination points as circles
            const destinationFeatures = supplyChainData
                .filter(item => item.destination && item.parent_supplier)
                .map(item => ({
                    'type': 'Feature',
                    'properties': {
                        'supplier': item.parent_supplier,
                        'country': item.parent_location,
                        'coordinates': `${item.destination[0].toFixed(4)}, ${item.destination[1].toFixed(4)}`,
                        'type': 'destination'
                    },
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [item.destination[1], item.destination[0]]
                    }
                }));

            map.addSource('destination-points', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': destinationFeatures
                }
            });

            // Create custom pin SVG
            const pinSVG = `
               <svg fill="#000000" height="8px" width="8px" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 21.041 21.041" xml:space="preserve"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g> <g id="c88_square"> <path d="M20.51,0H0.524C0.267,0,0.056,0.209,0.056,0.469v20.104c0,0.255,0.211,0.468,0.468,0.468H20.51 c0.263,0,0.476-0.213,0.476-0.468V0.469C20.986,0.209,20.772,0,20.51,0z"></path> </g> <g id="Capa_1_233_"> </g> </g> </g></svg>
            `;

            // Convert SVG to data URL
            const pinDataURL = 'data:image/svg+xml;base64,' + btoa(pinSVG);

            // Load the custom pin image
            const img = new Image();
            img.onload = () => {
                map.addImage('custom-pin', img);
                
                // Add source points layer with pins
                map.addLayer({
                    'id': 'source-points',
                    'type': 'symbol',
                    'source': 'source-points',
                    'layout': {
                        'icon-image': 'custom-pin',
                        'icon-size': 1.2,
                        'icon-anchor': 'bottom',
                        'icon-allow-overlap': true,
                        'icon-ignore-placement': true
                    }
                });

                // Add destination points layer with pins
                map.addLayer({
                    'id': 'destination-points',
                    'type': 'symbol',
                    'source': 'destination-points',
                    'layout': {
                        'icon-image': 'custom-pin',
                        'icon-size': 0.8,
                        'icon-anchor': 'bottom',
                        'icon-allow-overlap': true,
                        'icon-ignore-placement': true
                    }
                });
            };
            
            img.onerror = () => {
                console.error('Error loading custom pin, falling back to circles');
                addCircleLayers();
            };
            
            img.src = pinDataURL;

            // Fallback function for circle layers
            function addCircleLayers() {
                map.addLayer({
                    'id': 'source-points',
                    'type': 'circle',
                    'source': 'source-points',
                    'paint': {
                        'circle-radius': 6,
                        'circle-color': '#000000',
                        'circle-opacity': 1,
                        'circle-stroke-width': 0
                    }
                });

                map.addLayer({
                    'id': 'destination-points',
                    'type': 'circle',
                    'source': 'destination-points',
                    'paint': {
                        'circle-radius': 4,
                        'circle-color': '#000000',
                        'circle-opacity': 1,
                        'circle-stroke-width': 0
                    }
                });
            }

            // Function to close current popup and create new one
            function showPopup(lngLat, content) {
                // Close existing popup if it exists
                if (currentPopup) {
                    currentPopup.remove();
                }
                
                // Create new popup
                currentPopup = new mapboxgl.Popup({
                    offset: 25,
                    closeButton: true,
                    closeOnClick: false
                })
                    .setLngLat(lngLat)
                    .setHTML(content)
                    .addTo(map);

                // Clear the reference when popup is closed
                currentPopup.on('close', () => {
                    currentPopup = null;
                });
            }

            // Add click events for popups with enhanced styling
            map.on('click', 'source-points', (e) => {
                const properties = e.features[0].properties;
                const popupContent = `
                    <div class="stage-popup">
                        <div class="phase-section">
                            <div class="phase-title">${properties.phase}</div>
                            <p class="sub-phase-title">${properties.sub_phase}</p>
                            <div class="stage-badge">${properties.level}: ${properties.stage}</div>
                        </div>
                        
                        <div class="supplier-section">
                            <div class="supplier-label">Supplier</div>
                            <p class="supplier-name">${properties.supplier}</p>
                        </div>
                        
                        <div class="location-section">
                            <div class="detail-label">Location</div>
                            <p class="location-value">${properties.country}</p>
                        </div>
                    </div>
                `;
                
                showPopup(e.lngLat, popupContent);
            });

            map.on('click', 'destination-points', (e) => {
                const properties = e.features[0].properties;
                const popupContent = `
                    <div class="stage-popup">
                        <div class="phase-section">
                            <div class="phase-title">Destination Point</div>
                            <div class="stage-badge">Destination</div>
                        </div>
                        
                        <div class="supplier-section">
                            <div class="supplier-label">Supplier</div>
                            <p class="supplier-name">${properties.supplier}</p>
                        </div>
                        
                        <div class="location-section">
                            <div class="detail-label">Location</div>
                            <p class="location-value">${properties.country}</p>
                        </div>
                    </div>
                `;
                
                showPopup(e.lngLat, popupContent);
            });

            // Change cursor on hover
            map.on('mouseenter', 'source-points', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'source-points', () => {
                map.getCanvas().style.cursor = '';
            });
            map.on('mouseenter', 'destination-points', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'destination-points', () => {
                map.getCanvas().style.cursor = '';
            });

            // Fit map to show all points
            const allCoordinates = [];
            supplyChainData.forEach(item => {
                allCoordinates.push([item.source[1], item.source[0]]);
                if (item.destination) {
                    allCoordinates.push([item.destination[1], item.destination[0]]);
                }
            });

            const bounds = new mapboxgl.LngLatBounds();
            allCoordinates.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds, { padding: 50 });
        });
        
        // Add error handling
        map.on('error', (e) => {
            console.error('Mapbox error:', e);
            document.getElementById('map').innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: white; font-family: Arial, sans-serif; text-align: center; padding: 20px;">
                    <div>
                        <h2>Map Failed to Load</h2>
                        <p>Please ensure you have a valid Mapbox access token.</p>
                    </div>
                </div>
            `;
        });
    </script>
</body>
</html>